<!DOCTYPE html>
<html>
<head>
<title>Screen Monitor</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

<style>
body{
  background:#111;
  color:#fff;
  font-family:sans-serif;
  text-align:center;
}
video{
  width:360px;
  height:640px;
  background:black;
  border-radius:20px;
}
button{
  padding:12px 25px;
  margin:10px;
  font-size:16px;
}
</style>
</head>

<body>

<h2>Admin Screen Monitor</h2>

<input id="id" placeholder="Device ID">
<br><br>

<button onclick="start()">START SCREEN</button>
<button onclick="stop()">STOP</button>

<br><br>

<video id="v" autoplay playsinline></video>

<script>
const socket = io("https://child-v9no.onrender.com");

let pc = null;
let deviceId = "";

socket.on("connect", () => {
  console.log("ADMIN connected");
  socket.emit("join-room", "ADMIN");
});

/* ===============================
   RECEIVE OFFER FROM ANDROID
================================ */

socket.on("offer", async data => {

  console.log("ðŸ“© Offer received", data);

  deviceId = data.from || document.getElementById("id").value;

  pc = new RTCPeerConnection({
    iceServers:[
      { urls:"stun:stun.l.google.com:19302" }
    ]
  });

  pc.ontrack = e => {
    console.log("ðŸŽ¥ video track");
    document.getElementById("v").srcObject = e.streams[0];
  };

  pc.onicecandidate = e => {
    if(e.candidate){
      socket.emit("candidate",{
        target: deviceId,
        candidate: e.candidate.candidate,
        sdpMid: e.candidate.sdpMid,
        sdpMLineIndex: e.candidate.sdpMLineIndex
      });
    }
  };

  await pc.setRemoteDescription({
    type: "offer",
    sdp: data.offer.sdp
  });

  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);

  socket.emit("answer",{
    target: deviceId,
    sdp: answer.sdp
  });

});

/* ===============================
   RECEIVE ICE FROM ANDROID
================================ */

socket.on("candidate", data => {
  if(pc){
    pc.addIceCandidate({
      candidate: data.candidate,
      sdpMid: data.sdpMid,
      sdpMLineIndex: data.sdpMLineIndex
    });
  }
});

/* ===============================
   COMMANDS
================================ */

function start(){
  deviceId = document.getElementById("id").value;

  socket.emit("send-command",{
    targetId: deviceId,
    command: "start_screen"
  });
}

function stop(){
  socket.emit("send-command",{
    targetId: deviceId,
    command: "stop_screen"
  });

  if(pc){
    pc.close();
    pc = null;
  }
}
</script>

</body>
</html>
