<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shadow Control v2.0</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <style>
        :root {
            --bg-color: #0a0a0f;
            --panel-bg: rgba(20, 20, 30, 0.7);
            --accent: #00f3ff;
            --accent-glow: rgba(0, 243, 255, 0.4);
            --danger: #ff2a6d;
            --text-main: #ffffff;
            --border: 1px solid rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            margin: 0; 
            background-color: var(--bg-color); 
            color: var(--text-main);
            font-family: 'Rajdhani', sans-serif;
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 243, 255, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255, 42, 109, 0.05) 0%, transparent 20%);
        }

        /* --- HEADER --- */
        .top-bar {
            height: 60px;
            padding: 0 20px;
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            border-bottom: var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 0 10px var(--accent-glow);
        }

        .status-pill {
            background: rgba(0,0,0,0.3);
            padding: 5px 15px;
            border-radius: 20px;
            border: var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .dot { width: 8px; height: 8px; border-radius: 50%; background: #444; transition: 0.3s; }
        .dot.online { background: var(--accent); box-shadow: 0 0 8px var(--accent); }
        .dot.offline { background: var(--danger); box-shadow: 0 0 8px var(--danger); }

        /* --- MAIN LAYOUT --- */
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* --- VIDEO AREA --- */
        .video-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background: #000;
            overflow: hidden;
        }

        video {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            cursor: crosshair;
        }

        /* Ripple Effect for Click */
        .ripple {
            position: absolute;
            width: 20px; height: 20px;
            background: rgba(0, 243, 255, 0.6);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: ripple-anim 0.6s linear;
            pointer-events: none;
        }
        @keyframes ripple-anim {
            0% { width: 0; height: 0; opacity: 1; }
            100% { width: 100px; height: 100px; opacity: 0; }
        }

        /* --- SIDEBAR CONTROLS --- */
        .sidebar {
            width: 300px;
            background: var(--panel-bg);
            backdrop-filter: blur(15px);
            border-left: var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .control-group {
            background: rgba(255,255,255,0.03);
            padding: 15px;
            border-radius: 12px;
            border: var(--border);
        }

        .group-title {
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .btn-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .btn {
            background: rgba(255,255,255,0.05);
            border: none;
            color: #ccc;
            padding: 15px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-family: 'Rajdhani', sans-serif;
        }
        .btn:hover { background: rgba(0, 243, 255, 0.1); color: var(--accent); border: 1px solid var(--accent-glow); }
        .btn:active { transform: scale(0.95); }
        .btn i { font-size: 1.2rem; }
        .btn span { font-size: 0.7rem; }

        .btn-large { grid-column: span 3; background: var(--accent-glow); color: white; font-weight: bold; }
        .btn-large:hover { background: var(--accent); color: black; }
        
        .btn-danger { color: var(--danger); border: 1px solid rgba(255, 42, 109, 0.3); }
        .btn-danger:hover { background: var(--danger); color: white; }

        /* Keyboard Input */
        .input-box {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        .text-input {
            flex: 1;
            background: rgba(0,0,0,0.5);
            border: var(--border);
            color: white;
            padding: 8px;
            border-radius: 5px;
            outline: none;
        }
        .text-input:focus { border-color: var(--accent); }

        /* --- TOAST NOTIFICATION --- */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: var(--accent);
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid var(--accent);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1000;
            font-weight: bold;
        }

        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .sidebar { 
                width: 100%; 
                height: 40%; /* Bottom panel on mobile */
                border-left: none; 
                border-top: var(--border); 
            }
            .video-wrapper { height: 60%; }
            .brand span { display: none; }
        }

        /* Fullscreen Overlay Messages */
        .overlay-msg {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="brand">
            <i class="fa-solid fa-ghost"></i> <span>Shadow Control</span>
        </div>
        <div class="status-pill">
            <div id="statusDot" class="dot offline"></div>
            <span id="statusText">Disconnected</span>
        </div>
    </div>

    <div class="main-container">
        
        <div class="video-wrapper" id="videoContainer">
            <div class="overlay-msg" id="loadingMsg">
                <i class="fa-solid fa-satellite-dish fa-3x fa-spin"></i>
                <p style="margin-top:10px">Waiting for Connection...</p>
            </div>
            
            <video id="remoteVideo" autoplay playsinline muted></video>
            
            <button onclick="toggleFullscreen()" style="position:absolute; bottom:20px; right:20px; background:rgba(0,0,0,0.5); border:none; color:white; padding:10px; border-radius:5px; cursor:pointer; z-index:10;">
                <i class="fa-solid fa-expand"></i>
            </button>
        </div>

        <div class="sidebar">
            
            <div class="control-group">
                <div class="group-title">Connection</div>
                <button class="btn btn-large" onclick="forceStart()">
                    <i class="fa-solid fa-power-off"></i> START STREAM
                </button>
            </div>

            <div class="control-group">
                <div class="group-title">Navigation</div>
                <div class="btn-grid">
                    <button class="btn" onclick="sendCmd('back')"><i class="fa-solid fa-caret-left"></i><span>Back</span></button>
                    <button class="btn" onclick="sendCmd('home')"><i class="fa-regular fa-circle"></i><span>Home</span></button>
                    <button class="btn" onclick="sendCmd('recent')"><i class="fa-regular fa-square"></i><span>Recent</span></button>
                </div>
            </div>

            <div class="control-group">
                <div class="group-title">Gestures</div>
                <div class="btn-grid">
                    <button class="btn" onclick="sendCmd('swipe_up')"><i class="fa-solid fa-arrow-up"></i><span>Up</span></button>
                    <button class="btn" onclick="sendCmd('swipe_down')"><i class="fa-solid fa-arrow-down"></i><span>Down</span></button>
                    <button class="btn" onclick="sendCmd('unlock')"><i class="fa-solid fa-lock-open"></i><span>Wake</span></button>
                </div>
            </div>

            <div class="control-group">
                <div class="group-title">Remote Input</div>
                <div class="input-box">
                    <input type="text" id="typeInput" class="text-input" placeholder="Type here...">
                    <button class="btn" style="padding: 5px 15px;" onclick="sendText()"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>

             <div class="control-group">
                <div class="group-title">System</div>
                <div class="btn-grid">
                    <button class="btn" onclick="sendCmd('volume_down')"><i class="fa-solid fa-volume-low"></i></button>
                    <button class="btn btn-danger" onclick="sendCmd('lock')"><i class="fa-solid fa-lock"></i></button>
                    <button class="btn" onclick="sendCmd('volume_up')"><i class="fa-solid fa-volume-high"></i></button>
                </div>
            </div>

        </div>
    </div>

    <div id="toast" class="toast">Command Sent</div>

    <script>
        const SERVER_URL = "https://child-v9no.onrender.com"; // âœ… Server URL
        let socket;
        let peerConnection;
        let currentDeviceId = null;

        // URL se Device ID nikalo
        const urlParams = new URLSearchParams(window.location.search);
        currentDeviceId = urlParams.get('id');

        // WebRTC Config
        const rtcConfig = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        const remoteVideo = document.getElementById('remoteVideo');
        const statusText = document.getElementById('statusText');
        const statusDot = document.getElementById('statusDot');
        const loadingMsg = document.getElementById('loadingMsg');

        // --- ðŸš€ INITIALIZATION ---
        if (!currentDeviceId) {
            statusText.innerText = "Error: No Device ID";
            loadingMsg.innerHTML = "<span style='color:red'>Please add ?id=12345 to URL</span>";
        } else {
            initSocket();
        }

        function initSocket() {
            statusText.innerText = "Connecting...";
            socket = io(SERVER_URL, { transports: ['websocket'] });

            socket.on("connect", () => {
                setStatus(true);
                console.log("âœ… Connected. Joining Room:", currentDeviceId);
                socket.emit("join-room", currentDeviceId);
            });

            socket.on("disconnect", () => setStatus(false));

            // WebRTC Logic
            socket.on("offer", async (offer) => {
                console.log("ðŸ“© Offer Received");
                loadingMsg.style.display = "none";
                
                if (peerConnection) peerConnection.close();
                peerConnection = new RTCPeerConnection(rtcConfig);

                peerConnection.ontrack = event => {
                    remoteVideo.srcObject = event.streams[0];
                    showToast("Video Feed Active");
                };

                peerConnection.onicecandidate = event => {
                    if (event.candidate) {
                        socket.emit("candidate", { target: currentDeviceId, candidate: event.candidate });
                    }
                };

                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                socket.emit("answer", { target: currentDeviceId, answer: answer });
            });

            socket.on("candidate", async (candidate) => {
                if (peerConnection) await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            });
        }

        // --- ðŸ›  HELPER FUNCTIONS ---

        function setStatus(isOnline) {
            if(isOnline) {
                statusText.innerText = "Connected: " + currentDeviceId;
                statusText.style.color = "var(--accent)";
                statusDot.classList.remove('offline');
                statusDot.classList.add('online');
            } else {
                statusText.innerText = "Disconnected";
                statusText.style.color = "#888";
                statusDot.classList.remove('online');
                statusDot.classList.add('offline');
                loadingMsg.style.display = "block";
            }
        }

        function sendCmd(action) {
            if (!socket) return;
            // Vibration Feedback
            if(navigator.vibrate) navigator.vibrate(30);
            
            console.log("Sending:", action);
            socket.emit("control-event", {
                room: currentDeviceId,
                action: action,
                x: 0, y: 0
            });
            showToast(action.toUpperCase());
        }

        function forceStart() {
            sendCmd('start'); // Service ko force start karne ka signal
            loadingMsg.innerHTML = "<i class='fa-solid fa-hourglass-half fa-spin'></i> Requesting Stream...";
        }

        function sendText() {
            const txt = document.getElementById('typeInput').value;
            if(txt) {
                // Since basic android service might not support text directly, 
                // we send it as a custom action if supported, or log it.
                // For now, let's treat it as a special command if you implement it later.
                socket.emit("control-event", {
                    room: currentDeviceId,
                    action: "text_input", // Android side needs to handle this
                    text: txt
                });
                document.getElementById('typeInput').value = "";
                showToast("Text Sent: " + txt);
            }
        }

        // --- ðŸ‘† TAP HANDLING (PRECISE MATH) ---
        remoteVideo.addEventListener('click', (e) => {
            if(!currentDeviceId) return;

            const rect = remoteVideo.getBoundingClientRect();
            // Video ka asli size aur displayed size nikalo
            const videoRatio = remoteVideo.videoWidth / remoteVideo.videoHeight;
            const displayRatio = rect.width / rect.height;

            let drawWidth, drawHeight, startX, startY;

            // 'object-fit: contain' logic calculation
            if (displayRatio > videoRatio) {
                drawHeight = rect.height;
                drawWidth = drawHeight * videoRatio;
                startX = (rect.width - drawWidth) / 2;
                startY = 0;
            } else {
                drawWidth = rect.width;
                drawHeight = drawWidth / videoRatio;
                startX = 0;
                startY = (rect.height - drawHeight) / 2;
            }

            // Click coordinates relative to the video image
            const clickX = e.clientX - rect.left - startX;
            const clickY = e.clientY - rect.top - startY;

            // Coordinates valid range ke bahar hain? (Black bars pe click kiya)
            if (clickX < 0 || clickX > drawWidth || clickY < 0 || clickY > drawHeight) return;

            // Scale to original resolution
            const finalX = Math.round((clickX / drawWidth) * remoteVideo.videoWidth);
            const finalY = Math.round((clickY / drawHeight) * remoteVideo.videoHeight);

            // Visual Ripple
            createRipple(e.clientX, e.clientY);

            console.log(`Tap: ${finalX}, ${finalY}`);
            socket.emit("control-event", {
                room: currentDeviceId,
                action: "tap",
                x: finalX,
                y: finalY
            });
        });

        function createRipple(x, y) {
            const ripple = document.createElement('div');
            ripple.classList.add('ripple');
            ripple.style.left = `${x}px`;
            ripple.style.top = `${y}px`;
            document.body.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = "1";
            setTimeout(() => t.style.opacity = "0", 2000);
        }

        function toggleFullscreen() {
            const elem = document.getElementById("videoContainer");
            if (!document.fullscreenElement) {
                elem.requestFullscreen().catch(err => {
                    alert(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }
    </script>
</body>
</html>
