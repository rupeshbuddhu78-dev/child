<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Child Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
    <style>
        body { font-family: sans-serif; background: #111; color: white; text-align: center; margin: 0; }
        video { width: 90%; max-width: 400px; border: 2px solid #0f0; background: #000; margin-top: 20px; }
        .status { margin: 10px; color: #aaa; font-size: 14px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #28a745; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>

    <h2>Live Screen Monitor</h2>
    <div class="status" id="status">Connecting...</div>
    
    <video id="remoteVideo" autoplay playsinline muted></video>

    <br><br>
    <input type="text" id="deviceId" placeholder="Enter Device ID (e.g. 945428)" value="945428">
    <button onclick="startViewing()">Connect & View</button>

    <script>
        // âœ… APKA SERVER URL
        const SOCKET_URL = "https://child-v9no.onrender.com"; 
        
        let socket;
        let peerConnection;
        const config = {
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" }
            ]
        };

        function startViewing() {
            const deviceId = document.getElementById("deviceId").value;
            if(!deviceId) return alert("Enter Device ID");

            document.getElementById("status").innerText = "Joining Room: " + deviceId;

            // 1. Socket Connect
            socket = io(SOCKET_URL, {
                transports: ['websocket', 'polling']
            });

            socket.on("connect", () => {
                console.log("âœ… Connected to Server");
                document.getElementById("status").innerText = "Waiting for stream...";
                socket.emit("join-room", deviceId);
            });

            // 2. Wait for Offer (Android sends this)
            socket.on("offer", async (data) => {
                console.log("ðŸ“¡ Offer Received from Android");
                document.getElementById("status").innerText = "Offer Received... Negotiating";
                
                if (!peerConnection) createPeerConnection(deviceId);

                try {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(data.offer.sdp ? JSON.stringify(data.offer) : data.offer)));
                    
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);

                    console.log("âš¡ Sending Answer");
                    socket.emit("answer", {
                        target: deviceId,
                        answer: answer
                    });
                } catch (err) {
                    console.error("Error handling offer:", err);
                }
            });

            // 3. Handle Ice Candidates
            socket.on("candidate", async (data) => {
                if (peerConnection) {
                    try {
                        // Fix for nested candidate objects
                        let candidateData = data.candidate;
                        if (candidateData.candidate && typeof candidateData.candidate === 'object') {
                            candidateData = candidateData.candidate;
                        }
                        await peerConnection.addIceCandidate(new RTCIceCandidate(candidateData));
                        console.log("â„ï¸ ICE Candidate Added");
                    } catch (e) { console.error("Error adding candidate", e); }
                }
            });

            socket.on("disconnect", () => {
                document.getElementById("status").innerText = "Disconnected";
            });
        }

        function createPeerConnection(targetId) {
            peerConnection = new RTCPeerConnection(config);

            peerConnection.ontrack = (event) => {
                console.log("ðŸŽ¥ Video Stream Received!");
                document.getElementById("status").innerText = "Streaming Active ðŸ”´";
                const video = document.getElementById("remoteVideo");
                video.srcObject = event.streams[0];
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit("candidate", {
                        target: targetId,
                        candidate: event.candidate
                    });
                }
            };
        }
    </script>

</body>
</html>
