<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        /* Sirf ek extra fix: message-body mein wrap dalo */
        .modal-body { word-wrap: break-word; white-space: pre-wrap; }
    </style>
</head>
<body>
    <script>
        // ⚠️ SABSE ZAROORI CHANGE: Aapka Render URL aur Sahi API Path
        const RENDER_URL = "https://child-v9no.onrender.com";
        const DEVICE_ID = "Child_Phone_01";

        document.addEventListener("DOMContentLoaded", function() {
            fetchNotifications();
            // Har 15 second mein apne aap refresh hoga
            setInterval(fetchNotifications, 15000);
        });

        function fetchNotifications() {
            // Sahi path: /api/get-data/ID/notifications
            fetch(`${RENDER_URL}/api/get-data/${DEVICE_ID}/notifications`)
                .then(response => response.json())
                .then(data => {
                    const listContainer = document.getElementById("notif-list");
                    
                    // Agar data list nahi hai ya error hai
                    if (!data || !Array.isArray(data) || data.length === 0) {
                        listContainer.innerHTML = `
                            <div class="empty-state">
                                <i class="fa-solid fa-bell-slash" style="font-size: 3rem; margin-bottom: 10px;"></i>
                                <p>No Notifications Yet</p>
                                <small style="color:#777">App is waiting for new notifications...</small>
                            </div>`;
                        return;
                    }

                    listContainer.innerHTML = ""; 

                    // Nayi notification upar dikhane ke liye reverse
                    data.slice().reverse().forEach(notif => {
                        const appInfo = getAppStyle(notif.package_name);
                        const card = document.createElement("div");
                        card.className = "notif-card";
                        card.onclick = () => openModal(appInfo, notif.title, notif.message);

                        card.innerHTML = `
                            <div class="app-icon" style="color: ${appInfo.color}; border: 1px solid ${appInfo.color}40;">
                                <i class="${appInfo.icon}"></i>
                            </div>
                            <div class="content">
                                <div class="sender-name">${notif.title || "System"}</div>
                                <div class="preview-text">${notif.message || "No content"}</div>
                            </div>
                            <div class="time-badge">${notif.time || "Just now"}</div>
                        `;
                        listContainer.appendChild(card);
                    });
                })
                .catch(err => {
                    console.error("Error:", err);
                    document.getElementById("notif-list").innerHTML = `
                        <div class="empty-state" style="color: #ff4444;">
                            <i class="fa-solid fa-triangle-exclamation"></i>
                            <p>Server Connection Failed</p>
                        </div>`;
                });
        }

        function getAppStyle(pkg) {
            if(!pkg) return { icon: 'fa-solid fa-bell', color: '#ffffff', name: 'System' };
            pkg = pkg.toLowerCase();
            if (pkg.includes("whatsapp")) return { icon: 'fa-brands fa-whatsapp', color: '#25D366', name: 'WhatsApp' };
            if (pkg.includes("instagram")) return { icon: 'fa-brands fa-instagram', color: '#E1306C', name: 'Instagram' };
            if (pkg.includes("facebook")) return { icon: 'fa-brands fa-facebook', color: '#1877F2', name: 'Facebook' };
            if (pkg.includes("snapchat")) return { icon: 'fa-brands fa-snapchat', color: '#FFFC00', name: 'Snapchat' };
            if (pkg.includes("youtube")) return { icon: 'fa-brands fa-youtube', color: '#FF0000', name: 'YouTube' };
            if (pkg.includes("tele")) return { icon: 'fa-brands fa-telegram', color: '#0088cc', name: 'Telegram' };
            if (pkg.includes("gm") || pkg.includes("mail")) return { icon: 'fa-solid fa-envelope', color: '#D44638', name: 'Email' };
            return { icon: 'fa-solid fa-cube', color: '#aaaaaa', name: 'App' };
        }

        function openModal(appInfo, sender, message) {
            const modal = document.getElementById("detailModal");
            document.getElementById("modalIcon").innerHTML = `<i class="${appInfo.icon}"></i>`;
            document.getElementById("modalIcon").style.color = appInfo.color;
            document.getElementById("modalAppName").innerText = appInfo.name;
            document.getElementById("modalAppName").style.color = appInfo.color;
            document.getElementById("modalSender").innerText = sender || "Unknown";
            document.getElementById("modalMessage").innerText = message || "No message content available.";
            modal.style.display = "flex";
        }

        function closeModal(e) { if (e.target.id === "detailModal") closeModalDirect(); }
        function closeModalDirect() { document.getElementById("detailModal").style.display = "none"; }
    </script>
</body>
</html>
