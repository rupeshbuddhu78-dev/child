<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Notification Log</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #111;
            --border: #222;
            --text-main: #eee;
            --text-sub: #888;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            justify-content: center;
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
            position: relative;
        }

        /* --- Header --- */
        .header {
            padding: 20px;
            background: rgba(10, 10, 10, 0.95);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .header h2 { font-size: 18px; display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .badge-count { background: #333; color: #fff; font-size: 12px; padding: 2px 8px; border-radius: 10px; border: 1px solid #444; }

        /* --- List Area --- */
        .log-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Scrollbar styling */
        .log-list::-webkit-scrollbar { width: 4px; }
        .log-list::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

        /* --- Notification Card --- */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 15px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
            /* Animation hataya taaki refresh pe hile nahi, sirf naya aane pe dikhega */
            transition: background 0.2s;
        }
        
        .card:hover { background: #161616; }

        /* Icon Box */
        .app-icon {
            width: 42px; height: 42px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            flex-shrink: 0;
            background: #222;
            color: #fff;
        }

        /* Text Content */
        .content { flex: 1; overflow: hidden; }
        
        .row-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .app-name { font-size: 11px; text-transform: uppercase; font-weight: bold; letter-spacing: 0.5px; color: #666; }
        .time { font-size: 11px; color: #555; }

        .title { font-size: 15px; font-weight: 600; color: #fff; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .msg-text { font-size: 13.5px; color: #aaa; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* Loading/Empty State */
        .empty-state { text-align: center; color: #444; margin-top: 60px; font-size: 14px; }
        .loader { color: #444; font-size: 20px; margin-bottom: 10px; }

    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h2>
                <i class="fas fa-bell" style="color:#eee;"></i> System Log
                <span class="badge-count" id="countBadge">0</span>
            </h2>
            <i class="fas fa-circle" id="liveIndicator" style="font-size: 10px; color: #4caf50;" title="Live"></i>
        </div>

        <div class="log-list" id="logContainer">
            <div class="empty-state">
                <i class="fas fa-spinner fa-spin loader"></i><br>
                Connecting...
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const deviceId = urlParams.get('id');
        const API_URL = `https://child-v9no.onrender.com/api/get-data/${deviceId}/notifications`;

        // Is variable me hum purana data save karenge compare karne ke liye
        let lastKnownDataString = ""; 

        // --- 1. ICON & COLOR MAP ---
        const appMap = [
            // Social (WhatsApp Removed from here)
            { keys: ['instagram'], icon: 'fa-instagram', color: '#E1306C', bg: 'rgba(225, 48, 108, 0.1)' },
            { keys: ['facebook', 'fb'], icon: 'fa-facebook-f', color: '#1877F2', bg: 'rgba(24, 119, 242, 0.1)' },
            { keys: ['snapchat'], icon: 'fa-snapchat', color: '#FFFC00', bg: 'rgba(255, 252, 0, 0.1)' },
            { keys: ['telegram'], icon: 'fa-telegram', color: '#0088cc', bg: 'rgba(0, 136, 204, 0.1)' },
            { keys: ['sms', 'message'], icon: 'fa-comment-alt', color: '#4caf50', bg: 'rgba(76, 175, 80, 0.1)' },
            
            // Payment
            { keys: ['gpay', 'google pay', 'wallet'], icon: 'fa-google-pay', color: '#fff', bg: '#4285F4' },
            { keys: ['phonepe', 'paytm', 'navi', 'bhim', 'upi'], icon: 'fa-rupee-sign', color: '#673ab7', bg: 'rgba(103, 58, 183, 0.1)' },

            // Shopping
            { keys: ['blinkit', 'amazon', 'flipkart', 'jiomart', 'myntra', 'zomato', 'swiggy'], icon: 'fa-shopping-bag', color: '#ff9800', bg: 'rgba(255, 152, 0, 0.1)' },

            // Travel
            { keys: ['uber', 'ola', 'rapido', 'map'], icon: 'fa-map-marker-alt', color: '#f44336', bg: 'rgba(244, 67, 54, 0.1)' },

            // Tech/Email
            { keys: ['gmail', 'mail'], icon: 'fa-envelope', color: '#ea4335', bg: 'rgba(234, 67, 53, 0.1)' },
            { keys: ['youtube', 'video'], icon: 'fa-play', color: '#f00', bg: 'rgba(255, 0, 0, 0.1)' },
        ];

        function getStyle(appName, pkgName) {
            const searchText = (appName + " " + pkgName).toLowerCase();
            for (let item of appMap) {
                if (item.keys.some(k => searchText.includes(k))) return item;
            }
            return { icon: 'fa-bell', color: '#aaa', bg: '#222' }; // Default
        }

        // --- 2. FETCH DATA WITHOUT BLINKING ---
        async function fetchData() {
            if (!deviceId) return;

            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                
                // STEP A: WhatsApp Filter (Is line se WhatsApp gayab)
                const filteredData = data.filter(item => {
                    const name = (item.appName || "").toLowerCase();
                    const pkg = (item.packageName || "").toLowerCase();
                    // Agar app name ya package name me 'whatsapp' hai, to FALSE return karo (matlab list se hata do)
                    return !name.includes("whatsapp") && !pkg.includes("whatsapp");
                });

                // Sort: Newest First
                filteredData.sort((a, b) => b.postTime - a.postTime);

                // STEP B: Anti-Blink Logic
                // Hum check karenge ki kya naya data purane data se alag hai?
                // Agar same hai, to hum return kar denge (Kuch nahi karenge).
                const currentDataString = JSON.stringify(filteredData);
                
                if (currentDataString === lastKnownDataString) {
                    // Data same hai -> No Change -> No Blink
                    return; 
                }

                // Agar yahan aaye, matlab naya data aaya hai. Update karo.
                lastKnownDataString = currentDataString;
                renderList(filteredData);

            } catch (error) {
                console.error("API Error", error);
            }
        }

        function renderList(data) {
            const container = document.getElementById('logContainer');
            document.getElementById('countBadge').innerText = data.length;

            if(data.length === 0) {
                container.innerHTML = `<div class="empty-state">No other notifications</div>`;
                return;
            }

            let html = "";
            data.forEach(item => {
                const style = getStyle(item.appName || "", item.packageName || "");
                const timeStr = new Date(parseInt(item.postTime)).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                html += `
                    <div class="card">
                        <div class="app-icon" style="color: ${style.color}; background: ${style.bg}; border: 1px solid ${style.color}20;">
                            <i class="${style.icon}"></i>
                        </div>
                        <div class="content">
                            <div class="row-top">
                                <span class="app-name" style="color:${style.color}">${item.appName || "APP"}</span>
                                <span class="time">${timeStr}</span>
                            </div>
                            <div class="title">${item.title || "Notification"}</div>
                            <div class="msg-text">${item.text || ""}</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // First Load
        fetchData();
        
        // Check every 3 seconds
        setInterval(fetchData, 3000);

    </script>
</body>
</html>
